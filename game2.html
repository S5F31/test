<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©¦ç®¡æ¶²é«”è‡ªç”±åˆ†é¡éŠæˆ²</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e);
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
            padding: 25px;
            background: rgba(20, 20, 35, 0.8);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(100, 100, 150, 0.2);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            font-size: 3.2rem;
            margin-bottom: 15px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 25px rgba(255, 107, 107, 0.4);
            letter-spacing: 2px;
        }
        
        .subtitle {
            color: #b0b0d0;
            font-size: 1.3rem;
            margin-bottom: 15px;
            max-width: 800px;
            line-height: 1.6;
            margin: 0 auto 20px;
        }
        
        .game-stats {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 900px;
            margin-bottom: 35px;
            background: rgba(25, 25, 45, 0.9);
            padding: 25px 35px;
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(100, 100, 150, 0.2);
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
            padding: 0 15px;
            position: relative;
        }
        
        .stat-item:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 20%;
            height: 60%;
            width: 1px;
            background: rgba(100, 100, 150, 0.3);
        }
        
        .stat-value {
            font-size: 3.2rem;
            font-weight: bold;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 15px currentColor;
        }
        
        .moves-value {
            color: #4ecdc4;
        }
        
        .level-value {
            color: #feca57;
        }
        
        .time-value {
            color: #ff6b6b;
        }
        
        .chain-value {
            color: #a29bfe;
        }
        
        .score-value {
            color: #96ceb4;
        }
        
        .stat-label {
            color: #a0a0c0;
            font-size: 1.2rem;
            letter-spacing: 1px;
        }
        
        .game-board {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 40px;
        }
        
        .tubes-row {
            display: flex;
            justify-content: center;
            gap: 35px;
            flex-wrap: wrap;
            margin-bottom: 40px;
            padding: 25px;
            background: rgba(20, 20, 35, 0.7);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(100, 100, 150, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .tube-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tube {
            width: 100px;
            height: 280px;
            background: rgba(30, 30, 50, 0.9);
            border-radius: 10px 10px 50px 50px;
            position: relative;
            overflow: hidden;
            border: 4px solid rgba(100, 100, 150, 0.6);
            box-shadow: 
                inset 0 0 25px rgba(0, 0, 0, 0.6),
                0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .tube::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: rgba(40, 40, 60, 0.8);
            border-radius: 6px 6px 0 0;
            z-index: 2;
        }
        
        .liquid {
            position: absolute;
            bottom: 0;
            left: 5px;
            right: 5px;
            border-radius: 20px 20px 0 0;
            transition: height 0.5s ease;
            z-index: 1;
        }
        
        .liquid::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px 20px 0 0;
        }
        
        .tube-label {
            margin-top: 15px;
            color: #b0b0d0;
            font-size: 1.3rem;
            font-weight: bold;
            padding: 8px 20px;
            background: rgba(40, 40, 60, 0.8);
            border-radius: 10px;
            min-width: 100px;
            text-align: center;
            letter-spacing: 1px;
        }
        
        .tube-container.selected .tube {
            transform: translateY(-15px);
            border-color: #feca57;
            box-shadow: 
                inset 0 0 25px rgba(0, 0, 0, 0.6),
                0 0 30px rgba(254, 202, 87, 0.7);
        }
        
        .tube-container.selected .tube-label {
            color: #feca57;
            background: rgba(60, 50, 30, 0.8);
        }
        
        .tube-container:hover:not(.selected) .tube {
            transform: translateY(-8px);
            border-color: rgba(200, 200, 255, 0.8);
        }
        
        .tube-container.empty .tube-label {
            color: #888;
        }
        
        .tube-container.completed .tube {
            border-color: #4ecdc4;
            box-shadow: 
                inset 0 0 25px rgba(0, 0, 0, 0.6),
                0 0 25px rgba(78, 205, 196, 0.5);
        }
        
        .tube-container.completed .tube-label {
            color: #4ecdc4;
        }
        
        .liquid-count {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 0.8rem;
            padding: 2px 5px;
            border-radius: 3px;
            z-index: 3;
        }
        
        .game-controls {
            display: flex;
            gap: 25px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .game-btn {
            padding: 18px 40px;
            font-size: 1.3rem;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
            min-width: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #ff6b6b, #c44d58);
            color: white;
        }
        
        .hint-btn {
            background: linear-gradient(135deg, #feca57, #ff9f43);
            color: white;
        }
        
        .undo-btn {
            background: linear-gradient(135deg, #45b7d1, #3498db);
            color: white;
        }
        
        .solve-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }
        
        .game-btn:hover {
            transform: translateY(-7px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.4);
        }
        
        .game-btn:active {
            transform: translateY(-2px);
        }
        
        .game-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .game-info {
            display: flex;
            width: 100%;
            max-width: 900px;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .instructions {
            flex: 1;
            background: rgba(25, 25, 45, 0.9);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(100, 100, 150, 0.2);
        }
        
        .instructions h2 {
            color: #feca57;
            margin-bottom: 25px;
            font-size: 1.9rem;
            text-align: center;
        }
        
        .instructions-list {
            list-style-type: none;
        }
        
        .instructions-list li {
            margin-bottom: 18px;
            padding-left: 35px;
            position: relative;
            color: #d0d0e0;
            line-height: 1.6;
            font-size: 1.1rem;
        }
        
        .instructions-list li::before {
            content: "â—";
            color: #4ecdc4;
            font-size: 1.2rem;
            position: absolute;
            left: 0;
            top: 2px;
        }
        
        .hint-box {
            flex: 1;
            background: rgba(25, 25, 45, 0.9);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(100, 100, 150, 0.2);
            display: none;
        }
        
        .hint-box.active {
            display: block;
        }
        
        .hint-box h3 {
            color: #feca57;
            margin-bottom: 20px;
            font-size: 1.7rem;
            text-align: center;
        }
        
        .hint-text {
            color: #d0d0e0;
            font-size: 1.2rem;
            line-height: 1.6;
            text-align: center;
            padding: 15px;
            background: rgba(40, 40, 60, 0.6);
            border-radius: 10px;
            border-left: 4px solid #feca57;
        }
        
        .message-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .message-box {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 60px;
            border-radius: 25px;
            text-align: center;
            max-width: 700px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(100, 100, 150, 0.3);
            animation: messageAppear 0.5s ease-out;
        }
        
        @keyframes messageAppear {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .message-title {
            font-size: 3.5rem;
            margin-bottom: 25px;
            color: #feca57;
            text-shadow: 0 0 20px rgba(254, 202, 87, 0.7);
        }
        
        .message-content {
            font-size: 1.6rem;
            margin-bottom: 40px;
            color: #d0d0e0;
            line-height: 1.6;
        }
        
        .message-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 50px;
            background: rgba(30, 30, 50, 0.7);
            padding: 25px;
            border-radius: 15px;
        }
        
        .message-stat {
            text-align: center;
        }
        
        .message-stat-value {
            font-size: 2.8rem;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }
        
        .moves-stat {
            color: #4ecdc4;
        }
        
        .time-stat {
            color: #ff6b6b;
        }
        
        .score-stat {
            color: #feca57;
        }
        
        .message-stat-label {
            color: #a0a0c0;
            font-size: 1.2rem;
        }
        
        .close-btn {
            background: linear-gradient(135deg, #ff6b6b, #c44d58);
            color: white;
            padding: 18px 50px;
            font-size: 1.4rem;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(255, 107, 107, 0.4);
        }
        
        .liquid-animation {
            animation: liquidMove 1.5s ease-out;
        }
        
        @keyframes liquidMove {
            0% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0); }
        }
        
        .tube-shake {
            animation: shakeTube 0.5s ease-in-out;
        }
        
        @keyframes shakeTube {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .completed-pulse {
            animation: completedPulse 2s infinite;
        }
        
        @keyframes completedPulse {
            0% { box-shadow: 0 0 15px rgba(78, 205, 196, 0.5); }
            50% { box-shadow: 0 0 30px rgba(78, 205, 196, 0.8); }
            100% { box-shadow: 0 0 15px rgba(78, 205, 196, 0.5); }
        }
        
        .color-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
            border: 2px solid white;
        }
        
        /* æ–°å¢ï¼šæ¶²é«”é£›è¡Œå‹•ç•« */
        .flying-liquid {
            position: fixed;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            z-index: 1000;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 0 20px currentColor;
            pointer-events: none;
        }
        
        /* æ–°å¢ï¼šç²’å­ç‰¹æ•ˆ */
        .particle {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            z-index: 999;
            opacity: 0.8;
        }
        
        /* æ–°å¢ï¼šé€£é–æ•¸å­—é¡¯ç¤º */
        .chain-counter {
            position: fixed;
            font-size: 3rem;
            font-weight: bold;
            color: #feca57;
            text-shadow: 0 0 20px rgba(254, 202, 87, 0.8);
            z-index: 1001;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }
        
        /* æ–°å¢ï¼šæˆå°±å¾½ç«  */
        .achievement-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #8a6d00;
            font-size: 0.8rem;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 20px;
            margin: 2px;
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
            animation: badgeGlow 2s infinite;
        }
        
        @keyframes badgeGlow {
            0%, 100% { box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 4px 15px rgba(255, 215, 0, 0.6); }
        }
        
        /* æ–°å¢ï¼šæ’è¡Œæ¦œ */
        .leaderboard {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(25, 25, 45, 0.9);
            padding: 15px;
            border-radius: 15px;
            max-width: 300px;
            display: none;
            z-index: 999;
            border: 1px solid rgba(100, 100, 150, 0.2);
        }
        
        .leaderboard.show {
            display: block;
        }
        
        .leaderboard h3 {
            color: #feca57;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid rgba(100, 100, 150, 0.2);
        }
        
        .leaderboard-item:nth-child(1) .rank { color: #ffd700; font-weight: bold; }
        .leaderboard-item:nth-child(2) .rank { color: #c0c0c0; font-weight: bold; }
        .leaderboard-item:nth-child(3) .rank { color: #cd7f32; font-weight: bold; }
        
        .combo-effect {
            animation: comboPulse 0.3s;
        }
        
        @keyframes comboPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        footer {
            margin-top: 40px;
            color: #666;
            text-align: center;
            font-size: 1rem;
            padding: 25px;
            width: 100%;
            border-top: 1px solid rgba(100, 100, 150, 0.2);
        }
        
        @media (max-width: 1100px) {
            .tubes-row {
                gap: 25px;
            }
            
            .tube {
                width: 90px;
                height: 250px;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2.4rem;
            }
            
            .game-stats {
                flex-direction: column;
                gap: 25px;
                padding: 20px;
            }
            
            .stat-item:not(:last-child)::after {
                display: none;
            }
            
            .tubes-row {
                gap: 20px;
            }
            
            .tube {
                width: 80px;
                height: 220px;
            }
            
            .game-info {
                flex-direction: column;
            }
            
            .game-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .game-btn {
                width: 90%;
                max-width: 300px;
            }
            
            .message-box {
                padding: 40px 20px;
            }
            
            .message-title {
                font-size: 2.5rem;
            }
            
            .leaderboard {
                position: static;
                max-width: 100%;
                margin-top: 20px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 2rem;
            }
            
            .tube {
                width: 70px;
                height: 200px;
            }
            
            .tube-label {
                font-size: 1.1rem;
                min-width: 80px;
                padding: 6px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ§ª è©¦ç®¡æ¶²é«”è‡ªç”±åˆ†é¡</h1>
            <p class="subtitle">å°‡æ‰€æœ‰è©¦ç®¡è£¡çš„æ¶²é«”æŒ‰ç…§é¡è‰²åˆ†é–‹ï¼Œæ¯å€‹è©¦ç®¡è£¡åªç•™åŒä¸€ç¨®é¡è‰²çš„æ°´ã€‚å¯ä»¥å°‡æ¶²é«”å€’å…¥ä»»ä½•è©¦ç®¡ï¼Œåªè¦ä¸è¶…éå®¹é‡é™åˆ¶ã€‚</p>
        </header>
        
        <!-- æ–°å¢ï¼šæ’è¡Œæ¦œæŒ‰éˆ• -->
        <button class="game-btn" id="leaderboard-btn" style="background: linear-gradient(135deg, #a29bfe, #6c5ce7); margin-bottom: 20px;">
            <span>ğŸ†</span> æ’è¡Œæ¦œ
        </button>
        
        <!-- æ–°å¢ï¼šæ’è¡Œæ¦œ -->
        <div class="leaderboard" id="leaderboard">
            <h3>ğŸ† æ’è¡Œæ¦œ</h3>
            <div id="leaderboard-list"></div>
        </div>
        
        <div class="game-stats">
            <div class="stat-item">
                <div class="stat-value moves-value" id="moves">0</div>
                <div class="stat-label">ç§»å‹•æ¬¡æ•¸</div>
            </div>
            <div class="stat-item">
                <div class="stat-value level-value" id="level">1</div>
                <div class="stat-label">é—œå¡</div>
            </div>
            <div class="stat-item">
                <div class="stat-value time-value" id="time">0</div>
                <div class="stat-label">æ™‚é–“ (ç§’)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value chain-value" id="chain">0</div>
                <div class="stat-label">é€£é–</div>
            </div>
            <div class="stat-item">
                <div class="stat-value score-value" id="score">0</div>
                <div class="stat-label">åˆ†æ•¸</div>
            </div>
        </div>
        
        <div class="game-board">
            <div class="tubes-row" id="tubes-container">
                <!-- è©¦ç®¡æœƒç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="game-controls">
            <button class="game-btn start-btn" id="start-btn">
                <span>â–¶</span> é–‹å§‹éŠæˆ²
            </button>
            <button class="game-btn hint-btn" id="hint-btn">
                <span>ğŸ’¡</span> æç¤º
            </button>
            <button class="game-btn undo-btn" id="undo-btn" disabled>
                <span>â†¶</span> æ’¤æ¶ˆ
            </button>
            <button class="game-btn solve-btn" id="solve-btn">
                <span>âš¡</span> è‡ªå‹•è§£é¡Œ
            </button>
            <button class="game-btn reset-btn" id="reset-btn">
                <span>ğŸ”„</span> é‡æ–°é–‹å§‹
            </button>
        </div>
        
        <!-- æ–°å¢ï¼šæˆå°±é¡¯ç¤ºå€åŸŸ -->
        <div style="width: 100%; max-width: 900px; margin-bottom: 30px;">
            <h3 style="color: #feca57; text-align: center; margin-bottom: 15px;">ğŸ¯ æˆå°±ç³»çµ±</h3>
            <div id="achievements-container" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;"></div>
        </div>
        
        <div class="game-info">
            <div class="instructions">
                <h2>éŠæˆ²è¦å‰‡ï¼ˆè‡ªç”±ç‰ˆï¼‰</h2>
                <ul class="instructions-list">
                    <li><span class="color-indicator" style="background-color: #ff6b6b;"></span>ç›®æ¨™ï¼šå°‡æ‰€æœ‰è©¦ç®¡è£¡çš„æ¶²é«”æŒ‰ç…§é¡è‰²åˆ†é–‹ï¼Œæ¯å€‹è©¦ç®¡è£¡åªç•™åŒä¸€ç¨®é¡è‰²çš„æ°´</li>
                    <li><span class="color-indicator" style="background-color: #4ecdc4;"></span>æ“ä½œï¼šé»æ“Šä¸€å€‹è£æœ‰æ¶²é«”çš„è©¦ç®¡ï¼Œå†é»æ“Šå¦ä¸€å€‹ç›®æ¨™è©¦ç®¡ï¼Œå³å¯å°‡æœ€ä¸Šæ–¹çš„æ¶²é«”å€’å…¥ç›®æ¨™è©¦ç®¡</li>
                    <li><span class="color-indicator" style="background-color: #45b7d1;"></span>é‡è¦ï¼šå¯ä»¥å°‡æ¶²é«”å€’å…¥ä»»ä½•è©¦ç®¡ï¼Œä¸é™åˆ¶é¡è‰²ï¼å¯ä»¥å€’å…¥ä¸åŒé¡è‰²ä¸Šæ–¹</li>
                    <li><span class="color-indicator" style="background-color: #96ceb4;"></span>å®¹é‡ï¼šæ¯æ”¯è©¦ç®¡æœ€å¤šå®¹ç´4å€‹å–®ä½çš„æ¶²é«”ï¼Œè¶…éç„¡æ³•å€’å…¥</li>
                    <li><span class="color-indicator" style="background-color: #feca57;"></span>é€£é–ï¼šå®Œæˆä¸€å€‹æ»¿ç®¡çš„åŒè‰²æ¶²é«”æœƒè§¸ç™¼é€£é–åæ‡‰ï¼Œç²å¾—é¡å¤–åˆ†æ•¸ï¼</li>
                    <li><span class="color-indicator" style="background-color: #a29bfe;"></span>æˆå°±ï¼šå®Œæˆç‰¹å®šç›®æ¨™è§£é–æˆå°±å¾½ç« ï¼ŒæŒ‘æˆ°ä½ çš„æœ€é«˜åˆ†ï¼</li>
                </ul>
            </div>
            
            <div class="hint-box" id="hint-box">
                <h3>éŠæˆ²æç¤º</h3>
                <div class="hint-text" id="hint-text">
                    é»æ“Šã€Œæç¤ºã€æŒ‰éˆ•ç²å–å¹«åŠ©
                </div>
            </div>
        </div>
        
        <footer>
            <p>è©¦ç®¡æ¶²é«”è‡ªç”±åˆ†é¡éŠæˆ² | HTML5 + JavaScript å¯¦ç¾ | é…·ç‚«ç‰¹æ•ˆ + æˆå°±ç³»çµ±ï¼</p>
        </footer>
        
        <div class="message-overlay" id="message-overlay">
            <div class="message-box">
                <div class="message-title" id="message-title">æ­å–œï¼</div>
                <div class="message-content" id="message-content">ä½ æˆåŠŸå®Œæˆäº†ç¬¬1é—œï¼</div>
                
                <div class="message-stats">
                    <div class="message-stat">
                        <div class="message-stat-value moves-stat" id="message-moves">0</div>
                        <div class="message-stat-label">ç§»å‹•æ¬¡æ•¸</div>
                    </div>
                    <div class="message-stat">
                        <div class="message-stat-value time-stat" id="message-time">0</div>
                        <div class="message-stat-label">ç”¨æ™‚ (ç§’)</div>
                    </div>
                    <div class="message-stat">
                        <div class="message-stat-value score-stat" id="message-score">0</div>
                        <div class="message-stat-label">åˆ†æ•¸</div>
                    </div>
                </div>
                
                <!-- æ–°å¢ï¼šæˆå°±è§£é–é¡¯ç¤º -->
                <div id="achievements-unlocked" style="margin-bottom: 30px;"></div>
                
                <button class="close-btn" id="close-btn">ç¹¼çºŒä¸‹ä¸€é—œ</button>
            </div>
        </div>
    </div>

    <script>
        // éŠæˆ²é…ç½®
        const CONFIG = {
            totalTubes: 5,           // ç¸½è©¦ç®¡æ•¸
            maxLiquidPerTube: 4,     // æ¯æ”¯è©¦ç®¡æœ€å¤§å®¹é‡
            emptyTubes: 1,           // ç©ºè©¦ç®¡æ•¸é‡
            colors: [                // é¡è‰²å®šç¾©
                { name: "ç´…è‰²", value: "#ff6b6b", lightValue: "#ff8e8e" },
                { name: "è—è‰²", value: "#45b7d1", lightValue: "#6acae8" },
                { name: "ç¶ è‰²", value: "#96ceb4", lightValue: "#b0e6cc" },
                { name: "é»ƒè‰²", value: "#feca57", lightValue: "#ffd985" },
                { name: "ç´«è‰²", value: "#a29bfe", lightValue: "#b9b4ff" }
            ]
        };
        
        // æˆå°±ç³»çµ±å®šç¾©
        const ACHIEVEMENTS = {
            speedRunner: {
                id: "speedRunner",
                name: "é–ƒé›»å¿«æ‰‹",
                description: "30ç§’å…§å®Œæˆä¸€é—œ",
                icon: "âš¡",
                unlocked: false,
                check: function() { return gameState.time <= 30 && gameState.isPlaying === false; }
            },
            perfectionist: {
                id: "perfectionist",
                name: "å®Œç¾ä¸»ç¾©è€…",
                description: "ä»¥æœ€å°‘æ­¥æ•¸å®Œæˆ",
                icon: "ğŸ¯",
                unlocked: false,
                check: function() { 
                    const minMoves = gameState.colorsPerLevel * 3;
                    return gameState.moves <= minMoves && gameState.isPlaying === false;
                }
            },
            chainMaster: {
                id: "chainMaster",
                name: "é€£é–å¤§å¸«",
                description: "é”æˆ5æ¬¡é€£é–",
                icon: "ğŸ”—",
                unlocked: false,
                check: function() { return gameState.maxChain >= 5; }
            },
            highScore: {
                id: "highScore",
                name: "é«˜åˆ†ç©å®¶",
                description: "å–®å±€å¾—åˆ†è¶…é5000",
                icon: "ğŸ†",
                unlocked: false,
                check: function() { return calculateScore() >= 5000; }
            },
            levelExpert: {
                id: "levelExpert",
                name: "é—œå¡å°ˆå®¶",
                description: "å®Œæˆç¬¬5é—œ",
                icon: "â­",
                unlocked: false,
                check: function() { return gameState.level >= 5; }
            },
            fastLearner: {
                id: "fastLearner",
                name: "å¿«é€Ÿå­¸ç¿’è€…",
                description: "é¦–æ¬¡éŠæˆ²å°±é€šé—œ",
                icon: "ğŸš€",
                unlocked: false,
                check: function() { return gameState.gamesPlayed === 1 && gameState.isPlaying === false; }
            }
        };
        
        // éŠæˆ²ç‹€æ…‹
        const gameState = {
            level: 1,
            moves: 0,
            time: 0,
            isPlaying: false,
            timer: null,
            selectedTube: null,
            tubes: [],
            history: [],
            colorsPerLevel: 4,  // ç¬¬ä¸€é—œä½¿ç”¨4ç¨®é¡è‰²
            maxLevel: 10,
            chainCount: 0,
            maxChain: 0,
            score: 0,
            gamesPlayed: 0,
            achievements: JSON.parse(localStorage.getItem('tubeAchievements') || '{}'),
            leaderboard: JSON.parse(localStorage.getItem('tubeLeaderboard') || '[]')
        };
        
        // DOM å…ƒç´ 
        const elements = {
            moves: document.getElementById('moves'),
            level: document.getElementById('level'),
            time: document.getElementById('time'),
            chain: document.getElementById('chain'),
            score: document.getElementById('score'),
            startBtn: document.getElementById('start-btn'),
            hintBtn: document.getElementById('hint-btn'),
            undoBtn: document.getElementById('undo-btn'),
            solveBtn: document.getElementById('solve-btn'),
            resetBtn: document.getElementById('reset-btn'),
            tubesContainer: document.getElementById('tubes-container'),
            hintBox: document.getElementById('hint-box'),
            hintText: document.getElementById('hint-text'),
            messageOverlay: document.getElementById('message-overlay'),
            messageTitle: document.getElementById('message-title'),
            messageContent: document.getElementById('message-content'),
            messageMoves: document.getElementById('message-moves'),
            messageTime: document.getElementById('message-time'),
            messageScore: document.getElementById('message-score'),
            closeBtn: document.getElementById('close-btn'),
            leaderboardBtn: document.getElementById('leaderboard-btn'),
            leaderboard: document.getElementById('leaderboard'),
            leaderboardList: document.getElementById('leaderboard-list'),
            achievementsContainer: document.getElementById('achievements-container'),
            achievementsUnlocked: document.getElementById('achievements-unlocked')
        };
        
        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            gameState.moves = 0;
            gameState.time = 0;
            gameState.isPlaying = false;
            gameState.selectedTube = null;
            gameState.history = [];
            gameState.chainCount = 0;
            gameState.score = 0;
            
            clearInterval(gameState.timer);
            
            updateDisplay();
            createTubes();
            loadAchievements();
            renderAchievements();
            updateLeaderboard();
            
            elements.startBtn.innerHTML = '<span>â–¶</span> é–‹å§‹éŠæˆ²';
            elements.undoBtn.disabled = true;
            elements.hintBox.classList.remove('active');
            elements.leaderboard.classList.remove('show');
            
            // é‡ç½®é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.tube-container').forEach(tube => {
                tube.classList.remove('selected');
            });
        }
        
        // å‰µå»ºè©¦ç®¡
        function createTubes() {
            elements.tubesContainer.innerHTML = '';
            gameState.tubes = [];
            
            // è¨ˆç®—æœ¬é—œä½¿ç”¨çš„é¡è‰²
            const colorsInLevel = CONFIG.colors.slice(0, gameState.colorsPerLevel);
            
            // å‰µå»ºè©¦ç®¡å®¹å™¨
            for (let i = 0; i < CONFIG.totalTubes; i++) {
                const tubeContainer = document.createElement('div');
                tubeContainer.className = 'tube-container';
                tubeContainer.dataset.index = i;
                
                const tube = document.createElement('div');
                tube.className = 'tube';
                tube.id = `tube-${i}`;
                
                const tubeLabel = document.createElement('div');
                tubeLabel.className = 'tube-label';
                tubeLabel.textContent = `è©¦ç®¡ ${i + 1}`;
                
                tubeContainer.appendChild(tube);
                tubeContainer.appendChild(tubeLabel);
                elements.tubesContainer.appendChild(tubeContainer);
                
                // åˆå§‹åŒ–è©¦ç®¡ç‹€æ…‹
                gameState.tubes[i] = {
                    liquids: [],
                    element: tube,
                    label: tubeLabel,
                    container: tubeContainer
                };
            }
            
            // åˆ†é…æ¶²é«”åˆ°è©¦ç®¡
            distributeLiquids(colorsInLevel);
            
            // è¨­ç½®é»æ“Šäº‹ä»¶
            document.querySelectorAll('.tube-container').forEach((container, index) => {
                container.addEventListener('click', () => handleTubeClick(index));
            });
        }
        
        // åˆ†é…æ¶²é«”
        function distributeLiquids(colors) {
            // å‰µå»ºæ‰€æœ‰æ¶²é«”å–®å…ƒ
            let allLiquids = [];
            colors.forEach(color => {
                // æ¯ç¨®é¡è‰²4å€‹å–®ä½
                for (let i = 0; i < CONFIG.maxLiquidPerTube; i++) {
                    allLiquids.push(color);
                }
            });
            
            // æ‰“äº‚é †åº
            allLiquids.sort(() => Math.random() - 0.5);
            
            // è¨ˆç®—æ¯ç®¡æ‡‰æœ‰æ¶²é«”æ•¸ï¼ˆæœ€å¾Œä¸€ç®¡ç‚ºç©ºï¼‰
            const tubesWithLiquid = CONFIG.totalTubes - CONFIG.emptyTubes;
            const liquidsPerTube = Math.floor(allLiquids.length / tubesWithLiquid);
            
            // åˆ†é…æ¶²é«”åˆ°å‰å¹¾ç®¡
            for (let i = 0; i < tubesWithLiquid; i++) {
                const tubeLiquids = allLiquids.slice(i * liquidsPerTube, (i + 1) * liquidsPerTube);
                gameState.tubes[i].liquids = tubeLiquids;
                renderTube(i);
            }
            
            // æœ€å¾Œä¸€ç®¡ç‚ºç©º
            gameState.tubes[CONFIG.totalTubes - 1].liquids = [];
            gameState.tubes[CONFIG.totalTubes - 1].container.classList.add('empty');
            renderTube(CONFIG.totalTubes - 1);
            
            // å¦‚æœæœ‰å‰©é¤˜æ¶²é«”ï¼Œéš¨æ©Ÿåˆ†é…åˆ°éç©ºè©¦ç®¡
            const remainingLiquids = allLiquids.slice(tubesWithLiquid * liquidsPerTube);
            remainingLiquids.forEach(liquid => {
                const randomTube = Math.floor(Math.random() * tubesWithLiquid);
                if (gameState.tubes[randomTube].liquids.length < CONFIG.maxLiquidPerTube) {
                    gameState.tubes[randomTube].liquids.push(liquid);
                    renderTube(randomTube);
                }
            });
        }
        
        // æ¸²æŸ“è©¦ç®¡
        function renderTube(tubeIndex) {
            const tube = gameState.tubes[tubeIndex];
            const tubeElement = tube.element;
            
            // æ¸…ç©ºè©¦ç®¡
            tubeElement.innerHTML = '';
            
            // æ›´æ–°æ¨™ç±¤
            if (tube.liquids.length === 0) {
                tube.container.classList.add('empty');
            } else {
                tube.container.classList.remove('empty');
            }
            
            // æª¢æŸ¥è©¦ç®¡æ˜¯å¦å®Œæˆï¼ˆåŒä¸€é¡è‰²ï¼‰
            if (tube.liquids.length > 0) {
                const firstColor = tube.liquids[0].value;
                const allSame = tube.liquids.every(liquid => liquid.value === firstColor);
                
                if (allSame && tube.liquids.length === CONFIG.maxLiquidPerTube) {
                    tube.container.classList.add('completed');
                    tube.container.classList.add('completed-pulse');
                } else {
                    tube.container.classList.remove('completed');
                    tube.container.classList.remove('completed-pulse');
                }
            }
            
            // å‰µå»ºæ¶²é«”å±¤
            const liquidHeight = 280 / CONFIG.maxLiquidPerTube;
            
            tube.liquids.forEach((liquid, index) => {
                const liquidElement = document.createElement('div');
                liquidElement.className = 'liquid';
                liquidElement.style.backgroundColor = liquid.value;
                liquidElement.style.height = `${liquidHeight}px`;
                liquidElement.style.bottom = `${index * liquidHeight}px`;
                liquidElement.title = liquid.name;
                
                // æ·»åŠ æ¶²é¢æ•ˆæœ
                const surface = document.createElement('div');
                surface.style.position = 'absolute';
                surface.style.top = '0';
                surface.style.left = '0';
                surface.style.right = '0';
                surface.style.height = '15px';
                surface.style.background = `linear-gradient(to bottom, ${liquid.lightValue}, transparent)`;
                surface.style.borderRadius = '20px 20px 0 0';
                
                liquidElement.appendChild(surface);
                tubeElement.appendChild(liquidElement);
            });
            
            // æ·»åŠ æ¶²é«”æ•¸é‡æŒ‡ç¤º
            if (tube.liquids.length > 0) {
                const countIndicator = document.createElement('div');
                countIndicator.className = 'liquid-count';
                countIndicator.textContent = `${tube.liquids.length}/${CONFIG.maxLiquidPerTube}`;
                tubeElement.appendChild(countIndicator);
            }
        }
        
        // è™•ç†è©¦ç®¡é»æ“Š
        function handleTubeClick(tubeIndex) {
            if (!gameState.isPlaying) return;
            
            const tube = gameState.tubes[tubeIndex];
            
            // å¦‚æœæ²’æœ‰é¸ä¸­çš„è©¦ç®¡
            if (gameState.selectedTube === null) {
                // ä¸èƒ½é¸æ“‡ç©ºè©¦ç®¡ä½œç‚ºä¾†æº
                if (tube.liquids.length === 0) {
                    showHint("è«‹é¸æ“‡æœ‰æ¶²é«”çš„è©¦ç®¡");
                    shakeTube(tubeIndex);
                    return;
                }
                
                gameState.selectedTube = tubeIndex;
                tube.container.classList.add('selected');
                showHint(`å·²é¸æ“‡è©¦ç®¡ ${tubeIndex + 1}ï¼Œè«‹é¸æ“‡ç›®æ¨™è©¦ç®¡`);
            }
            // å¦‚æœå·²ç¶“æœ‰é¸ä¸­çš„è©¦ç®¡ï¼Œå˜—è©¦ç§»å‹•æ¶²é«”
            else if (gameState.selectedTube !== tubeIndex) {
                moveLiquid(gameState.selectedTube, tubeIndex);
                
                // å–æ¶ˆé¸ä¸­ç‹€æ…‹
                gameState.tubes[gameState.selectedTube].container.classList.remove('selected');
                gameState.selectedTube = null;
            }
            // å¦‚æœé»æ“ŠåŒä¸€æ”¯è©¦ç®¡ï¼Œå–æ¶ˆé¸ä¸­
            else {
                tube.container.classList.remove('selected');
                gameState.selectedTube = null;
                showHint("é¸æ“‡å·²å–æ¶ˆ");
            }
        }
        
        // ç§»å‹•æ¶²é«” - æ–°å¢ç‰¹æ•ˆç‰ˆæœ¬
        function moveLiquid(fromIndex, toIndex) {
            const fromTube = gameState.tubes[fromIndex];
            const toTube = gameState.tubes[toIndex];
            
            // æª¢æŸ¥ä¾†æºè©¦ç®¡æ˜¯å¦ç‚ºç©º
            if (fromTube.liquids.length === 0) {
                showHint("ä¾†æºè©¦ç®¡æ˜¯ç©ºçš„");
                shakeTube(fromIndex);
                return false;
            }
            
            // æª¢æŸ¥ç›®æ¨™è©¦ç®¡æ˜¯å¦å·²æ»¿
            if (toTube.liquids.length >= CONFIG.maxLiquidPerTube) {
                showHint("ç›®æ¨™è©¦ç®¡å·²æ»¿");
                shakeTube(toIndex);
                return false;
            }
            
            // ç²å–è¦ç§»å‹•çš„æ¶²é«”ï¼ˆæœ€ä¸Šå±¤ï¼‰
            const liquidToMove = fromTube.liquids[fromTube.liquids.length - 1];
            
            // è‡ªç”±ç‰ˆï¼šå¯ä»¥å€’å…¥ä»»ä½•è©¦ç®¡ï¼Œåªè¦ä¸è¶…éå®¹é‡ï¼
            
            // ä¿å­˜æ­·å²ç‹€æ…‹
            saveHistory();
            
            // é¡¯ç¤ºé…·ç‚«çš„é£›è¡Œå‹•ç•«
            pourLiquidAnimation(fromIndex, toIndex, liquidToMove.value);
            
            // åŸ·è¡Œç§»å‹•
            fromTube.liquids.pop();
            toTube.liquids.push(liquidToMove);
            
            // æ›´æ–°ç§»å‹•æ¬¡æ•¸
            gameState.moves++;
            
            // é‡æ–°æ¸²æŸ“å…©å€‹è©¦ç®¡
            renderTube(fromIndex);
            renderTube(toIndex);
            
            // æª¢æŸ¥é€£é–åæ‡‰
            checkChainReaction(toIndex);
            
            // æ›´æ–°é¡¯ç¤º
            updateDisplay();
            
            // å•Ÿç”¨æ’¤æ¶ˆæŒ‰éˆ•
            elements.undoBtn.disabled = false;
            
            // æª¢æŸ¥éŠæˆ²æ˜¯å¦å®Œæˆ
            if (checkWinCondition()) {
                endGame(true);
            }
            
            return true;
        }
        
        // é…·ç‚«çš„æ¶²é«”é£›è¡Œå‹•ç•«
        function pourLiquidAnimation(fromIndex, toIndex, color) {
            const fromTube = gameState.tubes[fromIndex].element;
            const toTube = gameState.tubes[toIndex].element;
            
            const fromRect = fromTube.getBoundingClientRect();
            const toRect = toTube.getBoundingClientRect();
            
            // å‰µå»ºé£›è¡Œçš„æ¶²é«”çƒ
            const flyingLiquid = document.createElement('div');
            flyingLiquid.className = 'flying-liquid';
            flyingLiquid.style.background = color;
            flyingLiquid.style.left = `${fromRect.left + fromRect.width/2}px`;
            flyingLiquid.style.top = `${fromRect.top + 30}px`;
            flyingLiquid.style.transform = 'scale(0)';
            flyingLiquid.style.boxShadow = `0 0 30px ${color}`;
            
            document.body.appendChild(flyingLiquid);
            
            // å‹•ç•«æ•ˆæœ
            setTimeout(() => {
                flyingLiquid.style.transform = 'scale(1)';
                
                setTimeout(() => {
                    flyingLiquid.style.left = `${toRect.left + toRect.width/2}px`;
                    flyingLiquid.style.top = `${toRect.top + 30}px`;
                    flyingLiquid.style.transform = 'scale(0.5)';
                    
                    // åˆ°é”ç›®æ¨™æ™‚çš„ç²’å­æ•ˆæœ
                    createSplashEffect(toRect.left + toRect.width/2, toRect.top + 30, color);
                    
                    setTimeout(() => {
                        flyingLiquid.remove();
                    }, 500);
                }, 100);
            }, 10);
        }
        
        // å‰µå»ºæ¿ºå°„ç²’å­æ•ˆæœ
        function createSplashEffect(x, y, color) {
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.background = color;
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.width = '8px';
                particle.style.height = '8px';
                
                document.body.appendChild(particle);
                
                // éš¨æ©Ÿæ–¹å‘é£›å‡º
                const angle = Math.random() * Math.PI * 2;
                const distance = 20 + Math.random() * 40;
                const duration = 400 + Math.random() * 400;
                
                const startX = x;
                const startY = y;
                
                let progress = 0;
                const animate = () => {
                    progress += 16 / duration;
                    
                    if (progress < 1) {
                        const currentX = startX + Math.cos(angle) * distance * progress;
                        const currentY = startY + Math.sin(angle) * distance * progress;
                        
                        particle.style.left = `${currentX}px`;
                        particle.style.top = `${currentY}px`;
                        particle.style.opacity = 1 - progress;
                        
                        requestAnimationFrame(animate);
                    } else {
                        particle.remove();
                    }
                };
                animate();
            }
        }
        
        // æª¢æŸ¥é€£é–åæ‡‰
        function checkChainReaction(tubeIndex) {
            const tube = gameState.tubes[tubeIndex];
            
            if (tube.liquids.length === CONFIG.maxLiquidPerTube) {
                const firstColor = tube.liquids[0].value;
                const allSame = tube.liquids.every(liquid => liquid.value === firstColor);
                
                if (allSame) {
                    // å¢åŠ é€£é–è¨ˆæ•¸
                    gameState.chainCount++;
                    gameState.maxChain = Math.max(gameState.maxChain, gameState.chainCount);
                    
                    // å¢åŠ åˆ†æ•¸ï¼ˆé€£é–å€ç‡ï¼‰
                    const chainBonus = 100 * gameState.chainCount;
                    gameState.score += chainBonus;
                    
                    // é¡¯ç¤ºé€£é–ç‰¹æ•ˆ
                    showChainEffect(tubeIndex, gameState.chainCount);
                    
                    // æª¢æŸ¥é€£é–å¤§å¸«æˆå°±
                    checkAchievements();
                    
                    // æ›´æ–°é¡¯ç¤º
                    updateDisplay();
                    
                    showHint(`é€£é–åæ‡‰ï¼ç¬¬${gameState.chainCount}æ¬¡é€£é– +${chainBonus}åˆ†`);
                    
                    // æª¢æŸ¥æ˜¯å¦é”æˆé€£é–æˆå°±
                    if (gameState.chainCount === 5) {
                        unlockAchievement('chainMaster');
                    }
                } else {
                    // é‡ç½®é€£é–è¨ˆæ•¸
                    gameState.chainCount = 0;
                }
            } else {
                // é‡ç½®é€£é–è¨ˆæ•¸
                gameState.chainCount = 0;
            }
        }
        
        // é¡¯ç¤ºé€£é–ç‰¹æ•ˆ
        function showChainEffect(tubeIndex, chainCount) {
            const tubeRect = gameState.tubes[tubeIndex].element.getBoundingClientRect();
            
            // é¡¯ç¤ºé€£é–æ•¸å­—
            const chainText = document.createElement('div');
            chainText.className = 'chain-counter';
            chainText.textContent = `${chainCount} é€£é–ï¼`;
            chainText.style.left = `${tubeRect.left + tubeRect.width/2}px`;
            chainText.style.top = `${tubeRect.top}px`;
            
            document.body.appendChild(chainText);
            
            // 3ç§’å¾Œç§»é™¤
            setTimeout(() => {
                chainText.remove();
            }, 1000);
            
            // è©¦ç®¡é€£é–ç‰¹æ•ˆ
            gameState.tubes[tubeIndex].container.classList.add('combo-effect');
            setTimeout(() => {
                gameState.tubes[tubeIndex].container.classList.remove('combo-effect');
            }, 300);
            
            // å¤§ç²’å­çˆ†ç‚¸æ•ˆæœ
            createExplosionEffect(tubeRect.left + tubeRect.width/2, tubeRect.top + tubeRect.height/2, 
                                gameState.tubes[tubeIndex].liquids[0].value);
        }
        
        // å‰µå»ºçˆ†ç‚¸ç²’å­æ•ˆæœ
        function createExplosionEffect(x, y, color) {
            for (let i = 0; i < 25; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.background = color;
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.width = `${10 + Math.random() * 15}px`;
                particle.style.height = particle.style.width;
                
                document.body.appendChild(particle);
                
                // çˆ†ç‚¸æ•ˆæœ
                const angle = Math.random() * Math.PI * 2;
                const distance = 50 + Math.random() * 100;
                const duration = 800 + Math.random() * 800;
                
                let progress = 0;
                const animate = () => {
                    progress += 16 / duration;
                    
                    if (progress < 1) {
                        const currentX = x + Math.cos(angle) * distance * progress;
                        const currentY = y + Math.sin(angle) * distance * progress;
                        
                        particle.style.left = `${currentX}px`;
                        particle.style.top = `${currentY}px`;
                        particle.style.opacity = 1 - progress;
                        particle.style.transform = `scale(${1 - progress})`;
                        
                        requestAnimationFrame(animate);
                    } else {
                        particle.remove();
                    }
                };
                animate();
            }
        }
        
        // æŠ–å‹•è©¦ç®¡ï¼ˆéŒ¯èª¤æç¤ºï¼‰
        function shakeTube(tubeIndex) {
            const tube = gameState.tubes[tubeIndex].container;
            tube.classList.add('tube-shake');
            
            setTimeout(() => {
                tube.classList.remove('tube-shake');
            }, 500);
        }
        
        // ä¿å­˜æ­·å²ç‹€æ…‹
        function saveHistory() {
            // æ·±æ‹·è²ç•¶å‰ç‹€æ…‹
            const stateCopy = gameState.tubes.map(tube => ({
                liquids: [...tube.liquids.map(l => ({...l}))]
            }));
            
            gameState.history.push(stateCopy);
            
            // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡
            if (gameState.history.length > 20) {
                gameState.history.shift();
            }
        }
        
        // æ’¤æ¶ˆæ“ä½œ
        function undoMove() {
            if (gameState.history.length === 0) return;
            
            // æ¢å¾©ä¸Šä¸€å€‹ç‹€æ…‹
            const lastState = gameState.history.pop();
            
            gameState.tubes.forEach((tube, index) => {
                tube.liquids = lastState[index].liquids.map(l => ({...l}));
                renderTube(index);
            });
            
            // æ›´æ–°ç§»å‹•æ¬¡æ•¸
            gameState.moves = Math.max(0, gameState.moves - 1);
            gameState.chainCount = 0;
            
            // æ›´æ–°é¡¯ç¤º
            updateDisplay();
            
            // å¦‚æœæ²’æœ‰æ›´å¤šæ­·å²è¨˜éŒ„ï¼Œç¦ç”¨æ’¤æ¶ˆæŒ‰éˆ•
            elements.undoBtn.disabled = gameState.history.length === 0;
            
            // å–æ¶ˆé¸ä¸­ç‹€æ…‹
            if (gameState.selectedTube !== null) {
                gameState.tubes[gameState.selectedTube].container.classList.remove('selected');
                gameState.selectedTube = null;
            }
            
            showHint("å·²æ’¤æ¶ˆä¸Šä¸€æ­¥æ“ä½œ");
        }
        
        // æª¢æŸ¥å‹åˆ©æ¢ä»¶
        function checkWinCondition() {
            for (let i = 0; i < gameState.tubes.length; i++) {
                const tube = gameState.tubes[i];
                
                // å¦‚æœè©¦ç®¡ç‚ºç©ºï¼Œè·³é
                if (tube.liquids.length === 0) continue;
                
                // æª¢æŸ¥æ‰€æœ‰æ¶²é«”æ˜¯å¦ç›¸åŒ
                const firstColor = tube.liquids[0].value;
                const allSame = tube.liquids.every(liquid => liquid.value === firstColor);
                
                // æª¢æŸ¥è©¦ç®¡æ˜¯å¦å·²æ»¿
                const isFull = tube.liquids.length === CONFIG.maxLiquidPerTube;
                
                if (!allSame || !isFull) return false;
            }
            
            return true;
        }
        
        // é–‹å§‹éŠæˆ²
        function startGame() {
            if (gameState.isPlaying) return;
            
            gameState.isPlaying = true;
            gameState.time = 0;
            gameState.moves = 0;
            gameState.chainCount = 0;
            gameState.score = 0;
            gameState.gamesPlayed++;
            
            elements.startBtn.innerHTML = '<span>â¸</span> éŠæˆ²é€²è¡Œä¸­';
            elements.startBtn.disabled = true;
            
            // å•Ÿå‹•è¨ˆæ™‚å™¨
            gameState.timer = setInterval(() => {
                gameState.time++;
                updateDisplay();
                
                // æ¯ç§’æ›´æ–°åˆ†æ•¸
                gameState.score = calculateScore();
                updateDisplay();
            }, 1000);
            
            updateDisplay();
            showHint("éŠæˆ²é–‹å§‹ï¼å¯ä»¥è‡ªç”±å°‡æ¶²é«”å€’å…¥ä»»ä½•è©¦ç®¡ï¼");
        }
        
        // çµæŸéŠæˆ²
        function endGame(isWin) {
            gameState.isPlaying = false;
            clearInterval(gameState.timer);
            
            elements.startBtn.innerHTML = '<span>â–¶</span> é–‹å§‹éŠæˆ²';
            elements.startBtn.disabled = false;
            
            // è¨ˆç®—æœ€çµ‚åˆ†æ•¸
            gameState.score = calculateScore();
            updateDisplay();
            
            // æª¢æŸ¥ä¸¦è§£é–æˆå°±
            checkAndUnlockAchievements();
            
            // æ›´æ–°æ’è¡Œæ¦œ
            updateLeaderboardWithNewScore();
            
            if (isWin) {
                elements.messageTitle.textContent = "æ­å–œå‹åˆ©ï¼";
                elements.messageContent.textContent = `ä½ æˆåŠŸå®Œæˆäº†ç¬¬${gameState.level}é—œï¼`;
                
                // é¡¯ç¤ºè§£é–çš„æˆå°±
                showUnlockedAchievements();
            } else {
                elements.messageTitle.textContent = "éŠæˆ²çµæŸ";
                elements.messageContent.textContent = "è«‹ç¹¼çºŒåŠªåŠ›ï¼";
            }
            
            elements.messageMoves.textContent = gameState.moves;
            elements.messageTime.textContent = gameState.time;
            elements.messageScore.textContent = gameState.score;
            
            elements.messageOverlay.style.display = 'flex';
        }
        
        // è¨ˆç®—åˆ†æ•¸
        function calculateScore() {
            const timeBonus = Math.max(0, 5000 - gameState.time * 10);
            const movesBonus = Math.max(0, 3000 - gameState.moves * 20);
            const levelBonus = gameState.level * 500;
            const chainBonus = gameState.chainCount * 100;
            const maxChainBonus = gameState.maxChain * 200;
            
            return timeBonus + movesBonus + levelBonus + chainBonus + maxChainBonus;
        }
        
        // ä¸‹ä¸€é—œ
        function nextLevel() {
            if (gameState.level < gameState.maxLevel) {
                gameState.level++;
                gameState.colorsPerLevel = Math.min(5, 3 + Math.floor(gameState.level / 2));
            }
            
            elements.messageOverlay.style.display = 'none';
            initGame();
        }
        
        // é¡¯ç¤ºæç¤º
        function showHint(text) {
            elements.hintText.textContent = text;
            elements.hintBox.classList.add('active');
            
            // 5ç§’å¾Œéš±è—æç¤º
            setTimeout(() => {
                elements.hintBox.classList.remove('active');
            }, 5000);
        }
        
        // æä¾›éŠæˆ²æç¤º
        function giveHint() {
            if (!gameState.isPlaying) {
                showHint("è«‹å…ˆé–‹å§‹éŠæˆ²");
                return;
            }
            
            // å°‹æ‰¾å¯èƒ½çš„ç§»å‹•
            const hint = findBestMove();
            
            if (hint) {
                const fromColor = gameState.tubes[hint.from].liquids.slice(-1)[0].name;
                const toColor = gameState.tubes[hint.to].liquids.length > 0 ? 
                    gameState.tubes[hint.to].liquids.slice(-1)[0].name : "ç©ºè©¦ç®¡";
                
                showHint(`æç¤ºï¼šå°‡è©¦ç®¡ ${hint.from + 1} çš„ ${fromColor} æ¶²é«”ç§»å‹•åˆ°è©¦ç®¡ ${hint.to + 1} (${toColor})`);
            } else {
                showHint("å˜—è©¦å°‡ç›¸åŒé¡è‰²çš„æ¶²é«”é›†ä¸­åœ¨ä¸€èµ·ï¼Œæˆ–ä½¿ç”¨ç©ºè©¦ç®¡é€²è¡Œæ•´ç†");
            }
        }
        
        // å°‹æ‰¾æœ€ä½³ç§»å‹•
        function findBestMove() {
            // ç­–ç•¥1ï¼šå„ªå…ˆå®Œæˆå·²æ¥è¿‘å®Œæˆçš„è©¦ç®¡
            for (let fromIndex = 0; fromIndex < gameState.tubes.length; fromIndex++) {
                const fromTube = gameState.tubes[fromIndex];
                if (fromTube.liquids.length === 0) continue;
                
                const topColor = fromTube.liquids[fromTube.liquids.length - 1];
                
                // å°‹æ‰¾ç›¸åŒé¡è‰²çš„è©¦ç®¡
                for (let toIndex = 0; toIndex < gameState.tubes.length; toIndex++) {
                    if (fromIndex === toIndex) continue;
                    
                    const toTube = gameState.tubes[toIndex];
                    if (toTube.liquids.length >= CONFIG.maxLiquidPerTube) continue;
                    
                    // å¦‚æœç›®æ¨™è©¦ç®¡æœ‰ç›¸åŒé¡è‰²ä¸”æœªæ»¿ï¼Œå„ªå…ˆç§»å‹•
                    if (toTube.liquids.length > 0) {
                        const targetTopColor = toTube.liquids[toTube.liquids.length - 1];
                        if (topColor.value === targetTopColor.value) {
                            return { from: fromIndex, to: toIndex };
                        }
                    }
                }
            }
            
            // ç­–ç•¥2ï¼šå¦‚æœæ²’æœ‰ç›¸åŒé¡è‰²ï¼Œå°‹æ‰¾ç©ºè©¦ç®¡
            for (let fromIndex = 0; fromIndex < gameState.tubes.length; fromIndex++) {
                const fromTube = gameState.tubes[fromIndex];
                if (fromTube.liquids.length === 0) continue;
                
                for (let toIndex = 0; toIndex < gameState.tubes.length; toIndex++) {
                    if (fromIndex === toIndex) continue;
                    
                    const toTube = gameState.tubes[toIndex];
                    if (toTube.liquids.length === 0) {
                        return { from: fromIndex, to: toIndex };
                    }
                }
            }
            
            // ç­–ç•¥3ï¼šéš¨ä¾¿æ‰¾ä¸€å€‹æœ‰æ•ˆç§»å‹•
            for (let fromIndex = 0; fromIndex < gameState.tubes.length; fromIndex++) {
                const fromTube = gameState.tubes[fromIndex];
                if (fromTube.liquids.length === 0) continue;
                
                for (let toIndex = 0; toIndex < gameState.tubes.length; toIndex++) {
                    if (fromIndex === toIndex) continue;
                    
                    const toTube = gameState.tubes[toIndex];
                    if (toTube.liquids.length < CONFIG.maxLiquidPerTube) {
                        return { from: fromIndex, to: toIndex };
                    }
                }
            }
            
            return null;
        }
        
        // è‡ªå‹•è§£é¡Œ
        function solvePuzzle() {
            if (!gameState.isPlaying) {
                showHint("è«‹å…ˆé–‹å§‹éŠæˆ²");
                return;
            }
            
            showHint("è‡ªå‹•è§£é¡Œä¸­... é€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“");
            
            // ç°¡å–®çš„è‡ªå‹•è§£é¡Œç®—æ³•
            setTimeout(() => {
                const move = findBestMove();
                if (move) {
                    // æ¨¡æ“¬é»æ“Šé¸ä¸­ä¾†æºè©¦ç®¡
                    gameState.selectedTube = move.from;
                    gameState.tubes[move.from].container.classList.add('selected');
                    
                    // ç¨å¾Œæ¨¡æ“¬é»æ“Šç›®æ¨™è©¦ç®¡
                    setTimeout(() => {
                        moveLiquid(move.from, move.to);
                        
                        // å–æ¶ˆé¸ä¸­ç‹€æ…‹
                        if (gameState.selectedTube !== null) {
                            gameState.tubes[gameState.selectedTube].container.classList.remove('selected');
                            gameState.selectedTube = null;
                        }
                        
                        showHint("è‡ªå‹•å®Œæˆäº†ä¸€æ­¥ç§»å‹•");
                    }, 500);
                } else {
                    showHint("ç„¡æ³•æ‰¾åˆ°æœ‰æ•ˆç§»å‹•");
                }
            }, 1000);
        }
        
        // æ›´æ–°é¡¯ç¤º
        function updateDisplay() {
            elements.moves.textContent = gameState.moves;
            elements.level.textContent = gameState.level;
            elements.time.textContent = gameState.time;
            elements.chain.textContent = gameState.chainCount;
            elements.score.textContent = gameState.score;
        }
        
        // æˆå°±ç³»çµ±å‡½æ•¸
        function loadAchievements() {
            // å¾æœ¬åœ°å­˜å„²åŠ è¼‰å·²è§£é–çš„æˆå°±
            Object.keys(ACHIEVEMENTS).forEach(key => {
                if (gameState.achievements[key]) {
                    ACHIEVEMENTS[key].unlocked = true;
                }
            });
        }
        
        function saveAchievements() {
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
            const unlockedAchievements = {};
            Object.keys(ACHIEVEMENTS).forEach(key => {
                if (ACHIEVEMENTS[key].unlocked) {
                    unlockedAchievements[key] = true;
                }
            });
            localStorage.setItem('tubeAchievements', JSON.stringify(unlockedAchievements));
            gameState.achievements = unlockedAchievements;
        }
        
        function renderAchievements() {
            elements.achievementsContainer.innerHTML = '';
            
            Object.values(ACHIEVEMENTS).forEach(achievement => {
                const badge = document.createElement('div');
                badge.className = 'achievement-badge';
                badge.innerHTML = `${achievement.unlocked ? achievement.icon : 'ğŸ”’'} ${achievement.name}`;
                badge.title = achievement.description + (achievement.unlocked ? ' (å·²è§£é–)' : ' (æœªè§£é–)');
                badge.style.opacity = achievement.unlocked ? '1' : '0.5';
                badge.style.cursor = 'help';
                
                elements.achievementsContainer.appendChild(badge);
            });
        }
        
        function checkAchievements() {
            Object.values(ACHIEVEMENTS).forEach(achievement => {
                if (!achievement.unlocked && achievement.check()) {
                    unlockAchievement(achievement.id);
                }
            });
        }
        
        function checkAndUnlockAchievements() {
            let unlockedCount = 0;
            
            Object.values(ACHIEVEMENTS).forEach(achievement => {
                if (!achievement.unlocked && achievement.check()) {
                    unlockAchievement(achievement.id);
                    unlockedCount++;
                }
            });
            
            return unlockedCount;
        }
        
        function unlockAchievement(achievementId) {
            if (ACHIEVEMENTS[achievementId] && !ACHIEVEMENTS[achievementId].unlocked) {
                ACHIEVEMENTS[achievementId].unlocked = true;
                saveAchievements();
                renderAchievements();
                
                // é¡¯ç¤ºæˆå°±è§£é–é€šçŸ¥
                showAchievementUnlocked(achievementId);
                
                return true;
            }
            return false;
        }
        
        function showAchievementUnlocked(achievementId) {
            const achievement = ACHIEVEMENTS[achievementId];
            if (!achievement) return;
            
            // å‰µå»ºè§£é–é€šçŸ¥
            const notification = document.createElement('div');
            notification.className = 'achievement-badge';
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.zIndex = '1002';
            notification.style.fontSize = '1.2rem';
            notification.style.padding = '15px 25px';
            notification.style.animation = 'badgeGlow 1s infinite';
            notification.innerHTML = `ğŸ‰ æˆå°±è§£é–ï¼š${achievement.icon} ${achievement.name}`;
            notification.title = achievement.description;
            
            document.body.appendChild(notification);
            
            // 3ç§’å¾Œç§»é™¤
            setTimeout(() => {
                notification.remove();
            }, 3000);
            
            // æ’­æ”¾éŸ³æ•ˆï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ');
                audio.volume = 0.3;
                audio.play();
            } catch (e) {
                // å¿½ç•¥éŸ³é »éŒ¯èª¤
            }
        }
        
        function showUnlockedAchievements() {
            const newlyUnlocked = Object.values(ACHIEVEMENTS).filter(
                a => a.unlocked && !gameState.achievements[a.id]
            );
            
            if (newlyUnlocked.length > 0) {
                elements.achievementsUnlocked.innerHTML = `
                    <h3 style="color: #feca57; margin-bottom: 15px;">ğŸ‰ æœ¬å±€è§£é–æˆå°±</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                        ${newlyUnlocked.map(a => 
                            `<div class="achievement-badge">${a.icon} ${a.name}</div>`
                        ).join('')}
                    </div>
                `;
            } else {
                elements.achievementsUnlocked.innerHTML = '';
            }
        }
        
        // æ’è¡Œæ¦œå‡½æ•¸
        function updateLeaderboard() {
            // æŒ‰åˆ†æ•¸æ’åº
            gameState.leaderboard.sort((a, b) => b.score - a.score);
            
            elements.leaderboardList.innerHTML = '';
            
            // é¡¯ç¤ºå‰10å
            gameState.leaderboard.slice(0, 10).forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <div>
                        <span class="rank">${index + 1}.</span>
                        <span>${entry.name || 'åŒ¿åç©å®¶'}</span>
                    </div>
                    <div>
                        <span style="color: #feca57;">${entry.score}</span>
                        <span style="font-size: 0.8rem; color: #888; margin-left: 5px;">Lv.${entry.level}</span>
                    </div>
                `;
                elements.leaderboardList.appendChild(item);
            });
            
            // å¦‚æœæ²’æœ‰è¨˜éŒ„ï¼Œé¡¯ç¤ºæç¤º
            if (gameState.leaderboard.length === 0) {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = '<div style="text-align: center; width: 100%; color: #888;">æš«ç„¡è¨˜éŒ„</div>';
                elements.leaderboardList.appendChild(item);
            }
        }
        
        function updateLeaderboardWithNewScore() {
            const playerName = prompt('æ­å–œä½ ç²å¾—é«˜åˆ†ï¼è«‹è¼¸å…¥ä½ çš„åå­—ï¼ˆå¯é¸ï¼‰ï¼š', 'ç©å®¶' + Math.floor(Math.random() * 1000));
            
            const newEntry = {
                name: playerName || 'åŒ¿åç©å®¶',
                score: gameState.score,
                level: gameState.level,
                moves: gameState.moves,
                time: gameState.time,
                date: new Date().toISOString()
            };
            
            gameState.leaderboard.push(newEntry);
            gameState.leaderboard.sort((a, b) => b.score - a.score);
            
            // åªä¿ç•™å‰50å
            if (gameState.leaderboard.length > 50) {
                gameState.leaderboard = gameState.leaderboard.slice(0, 50);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
            localStorage.setItem('tubeLeaderboard', JSON.stringify(gameState.leaderboard));
            
            updateLeaderboard();
        }
        
        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            elements.startBtn.addEventListener('click', startGame);
            elements.resetBtn.addEventListener('click', initGame);
            elements.hintBtn.addEventListener('click', giveHint);
            elements.undoBtn.addEventListener('click', undoMove);
            elements.solveBtn.addEventListener('click', solvePuzzle);
            elements.closeBtn.addEventListener('click', nextLevel);
            
            // æ’è¡Œæ¦œæŒ‰éˆ•
            elements.leaderboardBtn.addEventListener('click', () => {
                elements.leaderboard.classList.toggle('show');
                updateLeaderboard();
            });
            
            // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰æ’è¡Œæ¦œ
            document.addEventListener('click', (e) => {
                if (!elements.leaderboard.contains(e.target) && 
                    !elements.leaderboardBtn.contains(e.target)) {
                    elements.leaderboard.classList.remove('show');
                }
            });
        }
        
        // åˆå§‹åŒ–éŠæˆ²
        window.addEventListener('DOMContentLoaded', () => {
            initGame();
            setupEventListeners();
        });
    </script>
</body>
</html>