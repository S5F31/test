<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ninjaé£›åˆ€å¤§æŒ‘æˆ° - å®Œæ•´ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #gameContainer {
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 1;
        }

        /* é®ç½©å±¤ */
        .overlay-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #levelTransition {
            background-color: #2c1608;
            transform: translateX(100%);
            transition: transform 0.1s;
        }

        .slide-in {
            animation: slideIn 2s forwards;
        }

        @keyframes slideIn {
            0% { transform: translateX(100%); }
            20% { transform: translateX(0); }
            80% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        #startScreen {
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
        }

        #startBox {
            background: linear-gradient(135deg, #4a2c20, #2a1a10);
            padding: 40px 60px;
            border-radius: 20px;
            border: 4px solid #8B4513;
            text-align: center;
            box-shadow: 0 0 50px rgba(139, 69, 19, 0.5);
            min-width: 400px;
            max-width: 90%;
        }

        #startTitle {
            color: #FFD700;
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px #000;
        }

        .blink {
            animation: blinker 1s linear infinite;
            color: #FF4500;
            font-weight: bold;
        }

        @keyframes blinker {
            50% { opacity: 0; }
        }

        /* é ‚éƒ¨UI */
        #header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            padding: 15px 20px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 100;
            pointer-events: none;
        }
        
        .gameInfo {
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #8B4513;
            text-align: center;
            min-width: 80px;
            backdrop-filter: blur(5px);
            pointer-events: auto;
        }
        
        .gameInfo h3 { color: #AAA; font-size: 12px; margin-bottom: 2px; }
        .gameInfo p { font-size: 18px; font-weight: bold; color: #fff; }

        #livesDisplay {
            display: flex;
            gap: 5px;
            pointer-events: auto;
            background: rgba(0,0,0,0.5);
            padding: 5px;
            border-radius: 10px;
        }

        .heart {
            width: 25px;
            height: 25px;
            background-color: #FF0000;
            clip-path: polygon(50% 0%, 61% 15%, 98% 15%, 68% 40%, 80% 85%, 50% 65%, 20% 85%, 32% 40%, 2% 15%, 39% 15%);
            transition: all 0.2s;
        }
        .heart.lost { background-color: #555; transform: scale(0.8); opacity: 0.5; }
        
        #bossIndicator {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #FF0000, #FF4500);
            padding: 5px 20px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            z-index: 100;
            display: none;
        }
        
        /* è¼ªç›¤ */
        #wheelContainer {
            position: absolute;
            width: 300px;
            height: 300px;
            top: 40%; 
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
        }
        
        #wheel {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #8B5A2B;
            background-image: 
                repeating-radial-gradient(circle at 50% 50%, transparent 0, transparent 4px, rgba(60, 30, 0, 0.15) 5px, transparent 6px),
                repeating-conic-gradient(#8B5A2B 0deg, #A0683C 10deg, #8B5A2B 20deg);
            box-shadow: inset 0 0 40px rgba(0,0,0,0.6), 0 0 20px rgba(0,0,0,0.8);
            border: 6px solid #3E2710;
            transform-origin: center center;
        }

        #wheel::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #C0C0C0, #555);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        /* é£›åˆ€åŸºæœ¬æ¨£å¼ */
        .knife {
            position: absolute;
            width: 12px;
            height: 50px;
            background: linear-gradient(to right, #A9A9A9, #E0E0E0, #A9A9A9);
            border-radius: 4px 4px 2px 2px;
            z-index: 6;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        
        /* ä¸åŒé£›åˆ€æ¨£å¼ */
        .knife.basic::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 14px;
            background-color: #8B0000;
            border-radius: 50% 50% 0 0;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .knife.basic::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #FFD700;
            border-radius: 50%;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
        }

        .knife.fire {
            background: linear-gradient(to right, #FF4500, #FF8C00, #FF4500);
        }
        
        .knife.fire::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 14px;
            background: linear-gradient(to bottom, #FF0000, #8B0000);
            border-radius: 50% 50% 0 0;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 10px #FF4500;
        }
        
        .knife.fire::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #FFD700, #FF4500);
            border-radius: 50%;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            animation: fireGlow 0.5s infinite alternate;
        }

        @keyframes fireGlow {
            from { box-shadow: 0 0 5px #FF4500; }
            to { box-shadow: 0 0 15px #FFD700; }
        }

        .knife.ice {
            background: linear-gradient(to right, #00BFFF, #87CEFA, #00BFFF);
        }
        
        .knife.ice::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 14px;
            background: linear-gradient(to bottom, #00FFFF, #00CED1);
            border-radius: 50% 50% 0 0;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 10px #00FFFF;
        }
        
        .knife.ice::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #FFFFFF, #00BFFF);
            border-radius: 50%;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            animation: iceGlow 1s infinite alternate;
        }

        @keyframes iceGlow {
            from { box-shadow: 0 0 5px #00FFFF; }
            to { box-shadow: 0 0 15px #FFFFFF; }
        }

        .knife.poison {
            background: linear-gradient(to right, #32CD32, #ADFF2F, #32CD32);
        }
        
        .knife.poison::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 14px;
            background: linear-gradient(to bottom, #7CFC00, #228B22);
            border-radius: 50% 50% 0 0;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 10px #32CD32;
        }
        
        .knife.poison::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #ADFF2F, #006400);
            border-radius: 50%;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            animation: poisonGlow 0.7s infinite alternate;
        }

        @keyframes poisonGlow {
            from { box-shadow: 0 0 5px #32CD32; }
            to { box-shadow: 0 0 15px #ADFF2F; }
        }

        .knife.golden {
            background: linear-gradient(to right, #FFD700, #DAA520, #FFD700);
        }
        
        .knife.golden::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 14px;
            background: linear-gradient(to bottom, #FFD700, #B8860B);
            border-radius: 50% 50% 0 0;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 10px #FFD700;
        }
        
        .knife.golden::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #FFF, #FFD700);
            border-radius: 50%;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 10px #FFD700;
        }

        /* ç©å®¶æ§åˆ¶çš„é£›åˆ€ */
        #playerKnife {
            left: 50%;
            bottom: 100px;
            transform: translateX(-50%);
            z-index: 100;
        }

        /* å°–åˆº */
        .spike {
            position: absolute;
            width: 10px;
            height: 35px;
            background: linear-gradient(to bottom, #444, #222);
            border-radius: 2px;
            z-index: 6;
        }
        
        .spike::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 12px solid #666;
            top: -12px;
            left: -1px;
        }

        /* è˜‹æœ - è¼ƒå°ï¼Œ+10é‡‘å¹£ */
        .apple {
            position: absolute;
            width: 16px;
            height: 16px;
            background: radial-gradient(circle at 30% 30%, #FF0000, #8B0000);
            border-radius: 50%;
            z-index: 6;
        }
        .apple::before {
            content: '';
            position: absolute;
            width: 2px;
            height: 4px;
            background: #5D4037;
            top: -3px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* é¦™è•‰ - è¼ƒå¤§ï¼Œ+5é‡‘å¹£ */
        .banana {
            position: absolute;
            width: 24px;
            height: 12px;
            background: linear-gradient(to right, #FFD700, #FFA500, #FF8C00);
            border-radius: 50% 50% 30% 30%;
            z-index: 6;
            transform: rotate(-30deg);
        }
        .banana::before {
            content: '';
            position: absolute;
            width: 3px;
            height: 6px;
            background: #8B4513;
            top: -4px;
            left: 3px;
            border-radius: 2px;
        }

        /* ç‰¹æ®Šé“å…· */
        .special-item {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            z-index: 7;
            animation: float 2s ease-in-out infinite;
            border: 2px solid rgba(255,255,255,0.8);
        }

        @keyframes float {
            0%, 100% { transform: translate(-50%, -50%) translateY(0); }
            50% { transform: translate(-50%, -50%) translateY(-5px); }
        }

        /* UI æ–‡å­— */
        .knife-counter {
            position: absolute;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 2px 4px #000;
            z-index: 50;
        }

        #controls {
            position: absolute;
            bottom: 40px;
            width: 100%;
            text-align: center;
            z-index: 100;
            pointer-events: none;
        }

        .btn {
            background: linear-gradient(to bottom, #8B4513, #5D3A1A);
            border: 2px solid #A0683C;
            color: white;
            padding: 10px 40px;
            font-size: 20px;
            border-radius: 30px;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(139, 69, 19, 0.7);
        }

        /* é¢æ¿æ¨£å¼ */
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(20, 10, 5, 0.95);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #FFD700;
            text-align: center;
            z-index: 2500;
            min-width: 300px;
            display: none;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        
        .modal h2 { margin-bottom: 15px; color: #FFD700; }
        .modal p { margin-bottom: 10px; color: #fff; }
        
        /* æç¤ºè¨Šæ¯ */
        .toast {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 3000;
            white-space: nowrap;
        }

        /* æ–°æ·»åŠ çš„è¦–è¦ºæ•ˆæœ */
        .hit-effect {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(255,215,0,0.8), transparent);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            animation: hitEffect 0.5s forwards;
        }

        @keyframes hitEffect {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .score-popup {
            position: absolute;
            color: #FFD700;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 0 10px #000;
            animation: popup 1s forwards;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes popup {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }

        .combo-indicator {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            color: #FF4500;
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 15px rgba(255,69,0,0.8);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 150;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #FF4500;
        }

        .multiplier-display {
            position: absolute;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            font-weight: bold;
            color: #FF4500;
            text-shadow: 0 0 10px #FF4500;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #FF4500;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 150;
        }

        /* æ¨¡å¼é¸æ“‡æŒ‰éˆ• */
        .mode-btn {
            background: linear-gradient(45deg, #8B4513, #A0522D);
            border: 2px solid #D2691E;
            color: white;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .mode-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #FFD700;
        }
        
        .mode-btn.selected {
            background: linear-gradient(45deg, #D2691E, #FF8C00);
            box-shadow: 0 0 20px #FFD700;
        }

        /* é‡‘å¹£é¡¯ç¤º */
        #coinsDisplay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.6);
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #FFD700;
            color: #FFD700;
            font-weight: bold;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coins-icon {
            color: #FFD700;
            font-size: 18px;
        }

        /* å•†åº—æŒ‰éˆ• */
        .shop-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(45deg, #D2691E, #FF8C00);
            border: 2px solid #FFD700;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .shop-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255,215,0,0.8);
        }

        /* å•†åº—æ¨£å¼ */
        .shop-item {
            background: rgba(50, 25, 10, 0.8);
            border: 2px solid #8B4513;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .shop-item:hover {
            background: rgba(80, 40, 20, 0.9);
            transform: translateX(5px);
            border-color: #FFD700;
        }

        .shop-item.equipped {
            border-color: #32CD32;
            box-shadow: 0 0 10px rgba(50, 205, 50, 0.5);
        }

        .shop-item.owned {
            border-color: #FFD700;
        }

        .shop-item.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .knife-preview {
            width: 60px;
            height: 100px;
            position: relative;
        }

        .knife-name {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
            flex: 1;
        }

        .knife-price {
            font-size: 16px;
            color: #32CD32;
            font-weight: bold;
        }

        .knife-stats {
            font-size: 12px;
            color: #CCC;
            margin-top: 5px;
        }

        .buy-btn {
            background: linear-gradient(to bottom, #32CD32, #228B22);
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .buy-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px #32CD32;
        }

        .buy-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .equip-btn {
            background: linear-gradient(to bottom, #FFD700, #DAA520);
            border: none;
            color: black;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .equip-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px #FFD700;
        }

        .equip-btn.equipped {
            background: linear-gradient(to bottom, #32CD32, #228B22);
            color: white;
        }

        /* é¸é …å¡ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(80, 40, 20, 0.8);
            border: 1px solid #8B4513;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(100, 50, 25, 0.9);
        }

        .tab.active {
            background: linear-gradient(45deg, #D2691E, #FF8C00);
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        /* ç‰¹æ•ˆæè¿° */
        .effect-info {
            font-size: 12px;
            color: #87CEFA;
            margin-top: 3px;
            font-style: italic;
        }

        /* æˆå°±é€šçŸ¥ */
        .achievement-notification {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #4a2c20, #2a1a10);
            border: 3px solid #FFD700;
            padding: 15px;
            border-radius: 10px;
            z-index: 4000;
            animation: slideInRight 0.5s forwards, fadeOut 0.5s 2.5s forwards;
            min-width: 250px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%) translateY(-50%); }
            to { transform: translateX(0) translateY(-50%); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>

    <!-- é–‹å§‹ç•«é¢ -->
    <div id="startScreen" class="overlay-screen">
        <div id="startBox">
            <h1 id="startTitle">Ninjaé£›åˆ€å¤§æŒ‘æˆ°</h1>
            <div id="modeSelection">
                <h3 style="color:#FFD700; margin-bottom:20px;">é¸æ“‡éŠæˆ²æ¨¡å¼</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="mode-btn" data-mode="classic">ç¶“å…¸æ¨¡å¼</button>
                    <button class="mode-btn" data-mode="survival">ç”Ÿå­˜æ¨¡å¼</button>
                    <button class="mode-btn" data-mode="challenge">æŒ‘æˆ°æ¨¡å¼</button>
                    <button class="mode-btn" data-mode="boss_rush">Boss é€£æˆ°</button>
                </div>
            </div>
            <p style="color:#ddd; font-size:18px; margin-top:20px;">æŒ‰ä¸‹ <span class="blink">ç©ºç™½éµ</span> é–‹å§‹</p>
            <p style="color:#888; font-size:14px; margin-top:10px;">ç¢°åˆ°å…¶ä»–é£›åˆ€æ‰£è¡€ï¼Œç¢°åˆ°å°–åˆºç›´æ¥è¼¸</p>
            <p style="color:#FFD700; font-size:14px; margin-top:5px;">ç›®æ¨™ï¼šæˆåŠŸæ’æ»¿é£›åˆ€å³å¯éé—œ</p>
            <button id="shopAccessBtn" class="btn" style="margin-top: 20px;">é€²å…¥å•†åº—</button>
        </div>
    </div>

    <!-- å‡ç´šå‹•ç•« -->
    <div id="levelTransition" class="overlay-screen">
        <h1 style="color: #FFD700; font-size: 50px; text-shadow: 0 0 10px red;">é›£åº¦å‡ç´šï¼</h1>
        <h2 id="transitionLevelText" style="color: #FFF; margin-top: 10px;">Level 2</h2>
    </div>

    <div id="gameContainer">
        <div id="header">
            <div class="gameInfo">
                <h3>é—œå¡</h3>
                <p id="levelDisplay">1</p>
            </div>
            <div class="gameInfo">
                <h3>åˆ†æ•¸</h3>
                <p id="scoreDisplay">0</p>
            </div>
            <div id="livesDisplay">
                <div class="heart"></div>
                <div class="heart"></div>
                <div class="heart"></div>
            </div>
        </div>
        
        <div id="coinsDisplay">
            <span class="coins-icon">ğŸ’°</span>
            <span id="coinsAmount">0</span>
        </div>
        
        <button id="shopBtn" class="shop-btn" onclick="openShop()">
            <span>ğŸ›’</span>
            <span>å•†åº—</span>
        </button>
        
        <div id="bossIndicator">Boss é—œå¡ï¼</div>
        <div id="comboDisplay" class="combo-indicator">é€£æ“Š: 0</div>
        <div id="multiplierDisplay" class="multiplier-display">x1</div>
        
        <div id="wheelContainer">
            <div id="wheel"></div>
        </div>
        
        <!-- ç©å®¶æ§åˆ¶çš„é£›åˆ€ -->
        <div id="playerKnife" class="knife basic"></div>
        
        <div class="knife-counter" id="knifeCounter">å·²æ’: 0/5</div>
        
        <div id="controls">
            <button id="throwBtn" class="btn">æŠ•æ“² (ç©ºç™½éµ)</button>
        </div>
    </div>

    <!-- éŠæˆ²çµæŸ/å®Œæˆé¢æ¿ -->
    <div id="gameOverModal" class="modal">
        <h2 id="goTitle">éŠæˆ²çµæŸ</h2>
        <p id="goReason">åŸå› </p>
        <p>åˆ†æ•¸: <span id="goScore">0</span></p>
        <p>æœ€å¤§é€£æ“Š: <span id="goCombo">0</span></p>
        <p>ç²å¾—é‡‘å¹£: <span id="goCoins">0</span></p>
        <button class="btn" onclick="initGame()">é‡æ–°é–‹å§‹</button>
        <button class="btn" onclick="returnToMenu()">è¿”å›ä¸»é¸å–®</button>
    </div>

    <div id="levelCompleteModal" class="modal">
        <h2>é—œå¡å®Œæˆï¼</h2>
        <p>æˆåŠŸæ’æ»¿ <span id="lcKnives">0</span> æŠŠé£›åˆ€</p>
        <p>ç²å¾—åˆ†æ•¸: <span id="lcScore">0</span></p>
        <p>ç²å¾—é‡‘å¹£: +<span id="lcCoins">50</span></p>
        <button class="btn" onclick="nextLevelWithAnim()">ä¸‹ä¸€é—œ</button>
    </div>

    <!-- å•†åº—é¢æ¿ -->
    <div id="shopModal" class="modal">
        <h2>é£›åˆ€å•†åº—</h2>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('knives')">é£›åˆ€</div>
            <div class="tab" onclick="switchTab('effects')">ç‰¹æ•ˆ</div>
            <div class="tab" onclick="switchTab('boosts')">å¼·åŒ–</div>
        </div>
        
        <div id="shopContent">
            <!-- å•†å“å…§å®¹æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>
        
        <button class="btn" onclick="closeShop()" style="margin-top: 20px;">è¿”å›éŠæˆ²</button>
    </div>

    <!-- æç¤ºæ¡† -->
    <div id="toast" class="toast"></div>

    <script>
        // éŠæˆ²é…ç½®
        const CONFIG = {
            wheelRadius: 150,
            knifeSpeed: 25,
            collisionTolerance: 8,
            comboThreshold: 3,
            perfectHitRange: 5,
            specialItemChance: 0.15,
            maxKnives: 10
        };

        // éŠæˆ²æ¨¡å¼
        const GAME_MODES = {
            CLASSIC: 'classic',
            SURVIVAL: 'survival',
            CHALLENGE: 'challenge',
            BOSS_RUSH: 'boss_rush'
        };

        // é£›åˆ€é¡å‹å®šç¾©
        const KNIFE_TYPES = {
            basic: {
                name: "åŸºæœ¬é£›åˆ€",
                description: "æ™®é€šçš„å¿è€…é£›åˆ€",
                price: 0,
                owned: true,
                equipped: true,
                stats: {
                    damage: 1,
                    speed: 1,
                    specialEffect: null
                }
            },
            fire: {
                name: "ç«ç„°é£›åˆ€",
                description: "ç‡ƒç‡’çš„ç«ç„°ä¹‹åˆƒ",
                price: 500,
                owned: false,
                equipped: false,
                stats: {
                    damage: 1.2,
                    speed: 1,
                    specialEffect: "æœ‰æ©Ÿç‡é»ç‡ƒç›®æ¨™"
                }
            },
            ice: {
                name: "å¯’å†°é£›åˆ€",
                description: "å†°å†·çš„éœœå‡ä¹‹åˆƒ",
                price: 800,
                owned: false,
                equipped: false,
                stats: {
                    damage: 1,
                    speed: 0.9,
                    specialEffect: "æ¸›æ…¢ç›®æ¨™é€Ÿåº¦"
                }
            },
            poison: {
                name: "æ¯’è—¥é£›åˆ€",
                description: "å¡—æŠ¹åŠ‡æ¯’çš„åˆ€åˆƒ",
                price: 1200,
                owned: false,
                equipped: false,
                stats: {
                    damage: 1.5,
                    speed: 1,
                    specialEffect: "æŒçºŒå‚·å®³æ•ˆæœ"
                }
            },
            golden: {
                name: "é»ƒé‡‘é£›åˆ€",
                description: "ç´”é‡‘æ‰“é€ çš„å¥¢è¯é£›åˆ€",
                price: 2000,
                owned: false,
                equipped: false,
                stats: {
                    damage: 1,
                    speed: 1,
                    specialEffect: "ç²å¾—é‡‘å¹£+50%"
                }
            }
        };

        // æˆå°±ç³»çµ±
        const ACHIEVEMENTS = {
            PERFECT_10: { name: "ç¥æº–", desc: "é€£çºŒ10æ¬¡å®Œç¾å‘½ä¸­", unlocked: false, reward: 100 },
            COMBO_KING: { name: "é€£æ“Šç‹", desc: "é”åˆ°20é€£æ“Š", unlocked: false, reward: 150 },
            SURVIVAL_MASTER: { name: "ç”Ÿå­˜å¤§å¸«", desc: "ç”Ÿå­˜æ¨¡å¼é”åˆ°500åˆ†", unlocked: false, reward: 200 },
            BOSS_SLAYER: { name: "Bossæ®ºæ‰‹", desc: "æ“Šæ•—10å€‹Boss", unlocked: false, reward: 300 },
            PERFECT_GAME: { name: "å®Œç¾éŠæˆ²", desc: "ä¸€å‘½é€šé—œ5é—œ", unlocked: false, reward: 500 },
            RICH_NINJA: { name: "å¯Œæœ‰å¿è€…", desc: "æ“æœ‰10000é‡‘å¹£", unlocked: false, reward: 2000 }
        };

        let state = {
            level: 1,
            score: 0,
            coins: 0,
            lives: 3,
            knivesRequired: 5,
            knivesStuck: 0,
            wheelAngle: 0,
            wheelSpeed: 1.5,
            wheelDirection: 1,
            isPlaying: false,
            isThrowing: false,
            lastSwitchTime: 0,
            switchInterval: 4000,
            objects: [],
            specialItems: [],
            combo: 0,
            maxCombo: 0,
            multiplier: 1,
            perfectHitCount: 0,
            streak: 0,
            playerPos: { bottom: 100 },
            gameMode: GAME_MODES.CLASSIC,
            bossDefeated: 0,
            perfectLevels: 0,
            achievements: {},
            currentKnife: 'basic',
            ownedKnives: ['basic'],
            equippedKnives: ['basic'],
            shopData: {},
            gameBoosts: {
                extraLife: 0,
                scoreMultiplier: 1,
                coinMultiplier: 1
            }
        };

        // DOM å…ƒç´ 
        const wheel = document.getElementById('wheel');
        const wheelContainer = document.getElementById('wheelContainer');
        const playerKnife = document.getElementById('playerKnife');
        const startScreen = document.getElementById('startScreen');
        const levelTransition = document.getElementById('levelTransition');
        const toastEl = document.getElementById('toast');
        const comboDisplay = document.getElementById('comboDisplay');
        const multiplierDisplay = document.getElementById('multiplierDisplay');
        const coinsDisplay = document.getElementById('coinsAmount');
        const shopBtn = document.getElementById('shopBtn');
        const shopModal = document.getElementById('shopModal');

        // åˆå§‹åŒ–
        window.onload = () => {
            loadGameData();
            setupInputs();
            createModeSelection();
            gameLoop();
        };

        function loadGameData() {
            // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘åªè¼‰å…¥å·²ä¿å­˜çš„æ•¸æ“šï¼Œä½†æ¯æ¬¡é‡æ–°é€²å…¥éŠæˆ²æ™‚é‡‘å¹£æ‡‰è©²æ¸…é›¶
            // æ‰€ä»¥æˆ‘å€‘åœ¨ startGame() ä¸­é‡ç½®é‡‘å¹£
            
            const savedAchievements = localStorage.getItem('ninja_achievements');
            if(savedAchievements) {
                state.achievements = JSON.parse(savedAchievements);
                Object.keys(ACHIEVEMENTS).forEach(key => {
                    if(state.achievements[key]) {
                        ACHIEVEMENTS[key].unlocked = true;
                    }
                });
            }
            
            const savedShopData = localStorage.getItem('ninja_shop');
            if(savedShopData) {
                state.shopData = JSON.parse(savedShopData);
                // æ›´æ–°é£›åˆ€æ“æœ‰ç‹€æ…‹
                if(state.shopData.ownedKnives) {
                    state.ownedKnives = state.shopData.ownedKnives;
                }
                if(state.shopData.currentKnife) {
                    state.currentKnife = state.shopData.currentKnife;
                    updatePlayerKnifeAppearance();
                }
                if(state.shopData.gameBoosts) {
                    state.gameBoosts = state.shopData.gameBoosts;
                }
            }
            
            updateCoinsDisplay();
        }

        function saveGameData() {
            localStorage.setItem('ninja_gameMode', state.gameMode);
            localStorage.setItem('ninja_achievements', JSON.stringify(state.achievements));
            
            // ä¿å­˜å•†åº—æ•¸æ“š
            state.shopData = {
                ownedKnives: state.ownedKnives,
                currentKnife: state.currentKnife,
                gameBoosts: state.gameBoosts
            };
            localStorage.setItem('ninja_shop', JSON.stringify(state.shopData));
        }

        function setupInputs() {
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    e.preventDefault();
                    if (!state.isPlaying && startScreen.style.display !== 'none') {
                        startGame();
                    } else if (state.isPlaying) {
                        throwKnife();
                    }
                }
                
                // å¿«æ·éµï¼šRé‡æ–°é–‹å§‹ï¼ŒMè¿”å›é¸å–®ï¼ŒSå•†åº—
                if (e.code === 'KeyR' && !startScreen.style.display) {
                    initGame();
                }
                if (e.code === 'KeyM' && !startScreen.style.display) {
                    returnToMenu();
                }
                if (e.code === 'KeyS' && state.isPlaying) {
                    openShop();
                }
            });

            document.getElementById('throwBtn').addEventListener('click', () => {
                if (!state.isPlaying && startScreen.style.display !== 'none') {
                    startGame();
                } else if (state.isPlaying) {
                    throwKnife();
                }
            });

            document.getElementById('shopAccessBtn').addEventListener('click', openShop);

            startScreen.addEventListener('click', (e) => {
                if(e.target.closest('#startBox')) startGame();
            });
        }

        function createModeSelection() {
            const modeButtons = document.querySelectorAll('.mode-btn');
            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    modeButtons.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    state.gameMode = btn.dataset.mode;
                    localStorage.setItem('ninja_gameMode', state.gameMode);
                });
                
                if(btn.dataset.mode === state.gameMode) {
                    btn.classList.add('selected');
                }
            });
        }

        // å•†åº—åŠŸèƒ½
        function openShop() {
            state.isPlaying = false;
            shopModal.style.display = 'block';
            renderShopContent('knives');
        }

        function closeShop() {
            shopModal.style.display = 'none';
            if(state.gameMode !== '') {
                state.isPlaying = true;
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderShopContent(tabName);
        }

        function renderShopContent(tabName) {
            const shopContent = document.getElementById('shopContent');
            shopContent.innerHTML = '';
            
            switch(tabName) {
                case 'knives':
                    renderKnivesShop();
                    break;
                case 'effects':
                    renderEffectsShop();
                    break;
                case 'boosts':
                    renderBoostsShop();
                    break;
            }
        }

        function renderKnivesShop() {
            const shopContent = document.getElementById('shopContent');
            
            Object.entries(KNIFE_TYPES).forEach(([id, knife]) => {
                const isOwned = state.ownedKnives.includes(id);
                const isEquipped = state.currentKnife === id;
                const canAfford = state.coins >= knife.price;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = `shop-item ${isOwned ? 'owned' : ''} ${isEquipped ? 'equipped' : ''}`;
                
                // å‰µå»ºé è¦½åœ–
                const previewDiv = document.createElement('div');
                previewDiv.className = 'knife-preview';
                const previewKnife = document.createElement('div');
                previewKnife.className = `knife ${id}`;
                previewKnife.style.position = 'absolute';
                previewKnife.style.left = '50%';
                previewKnife.style.top = '50%';
                previewKnife.style.transform = 'translate(-50%, -50%)';
                previewDiv.appendChild(previewKnife);
                
                const infoDiv = document.createElement('div');
                infoDiv.style.flex = '1';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'knife-name';
                nameDiv.textContent = knife.name;
                
                const descDiv = document.createElement('div');
                descDiv.className = 'knife-stats';
                descDiv.textContent = knife.description;
                
                const statsDiv = document.createElement('div');
                statsDiv.className = 'knife-stats';
                statsDiv.innerHTML = `
                    å‚·å®³: ${knife.stats.damage}x |
                    é€Ÿåº¦: ${knife.stats.speed}x
                    ${knife.stats.specialEffect ? `<div class="effect-info">æ•ˆæœ: ${knife.stats.specialEffect}</div>` : ''}
                `;
                
                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(descDiv);
                infoDiv.appendChild(statsDiv);
                
                const actionDiv = document.createElement('div');
                
                if (isOwned) {
                    const equipBtn = document.createElement('button');
                    equipBtn.className = `equip-btn ${isEquipped ? 'equipped' : ''}`;
                    equipBtn.textContent = isEquipped ? 'å·²è£å‚™' : 'è£å‚™';
                    equipBtn.onclick = () => equipKnife(id);
                    equipBtn.disabled = isEquipped;
                    actionDiv.appendChild(equipBtn);
                } else {
                    const priceDiv = document.createElement('div');
                    priceDiv.className = 'knife-price';
                    priceDiv.innerHTML = `ğŸ’° ${knife.price}`;
                    actionDiv.appendChild(priceDiv);
                    
                    const buyBtn = document.createElement('button');
                    buyBtn.className = 'buy-btn';
                    buyBtn.textContent = 'è³¼è²·';
                    buyBtn.onclick = () => buyKnife(id, knife.price);
                    buyBtn.disabled = !canAfford;
                    actionDiv.appendChild(buyBtn);
                }
                
                itemDiv.appendChild(previewDiv);
                itemDiv.appendChild(infoDiv);
                itemDiv.appendChild(actionDiv);
                shopContent.appendChild(itemDiv);
            });
        }

        function renderEffectsShop() {
            const shopContent = document.getElementById('shopContent');
            shopContent.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h3 style="color:#FFD700;">ç‰¹æ•ˆå•†åº—</h3>
                    <p style="color:#CCC; margin: 10px 0;">ç‚ºä½ çš„é£›åˆ€æ·»åŠ ç‚«é…·ç‰¹æ•ˆï¼</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                        <div class="shop-item">
                            <div style="font-size: 30px;">âœ¨</div>
                            <div style="flex:1;">
                                <div class="knife-name">æ˜Ÿå…‰ç‰¹æ•ˆ</div>
                                <div class="knife-stats">è®“é£›åˆ€æ‹–è‘—æ˜Ÿå…‰è»Œè·¡</div>
                                <div class="knife-price">ğŸ’° 300</div>
                            </div>
                            <button class="buy-btn">è³¼è²·</button>
                        </div>
                        <div class="shop-item">
                            <div style="font-size: 30px;">ğŸ’¥</div>
                            <div style="flex:1;">
                                <div class="knife-name">çˆ†ç‚¸ç‰¹æ•ˆ</div>
                                <div class="knife-stats">æ“Šä¸­æ™‚ç”¢ç”Ÿçˆ†ç‚¸æ•ˆæœ</div>
                                <div class="knife-price">ğŸ’° 500</div>
                            </div>
                            <button class="buy-btn">è³¼è²·</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderBoostsShop() {
            const shopContent = document.getElementById('shopContent');
            shopContent.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h3 style="color:#FFD700;">å¼·åŒ–é“å…·</h3>
                    <p style="color:#CCC; margin: 10px 0;">è³¼è²·è‡¨æ™‚å¼·åŒ–æ•ˆæœï¼</p>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px;">
                        <div class="shop-item">
                            <div style="font-size: 30px;">â¤ï¸</div>
                            <div style="flex:1;">
                                <div class="knife-name">é¡å¤–ç”Ÿå‘½</div>
                                <div class="knife-stats">+1 æœ€å¤§ç”Ÿå‘½å€¼</div>
                                <div class="knife-price">ğŸ’° 200/å€‹</div>
                            </div>
                            <button class="buy-btn" onclick="buyBoost('extraLife', 200)">è³¼è²·</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function buyKnife(knifeId, price) {
            if(state.coins >= price) {
                state.coins -= price;
                state.ownedKnives.push(knifeId);
                showToast(`è³¼è²·æˆåŠŸ: ${KNIFE_TYPES[knifeId].name}`);
                updateCoinsDisplay();
                saveGameData();
                renderShopContent('knives');
            } else {
                showToast("é‡‘å¹£ä¸è¶³ï¼");
            }
        }

        function equipKnife(knifeId) {
            state.currentKnife = knifeId;
            updatePlayerKnifeAppearance();
            saveGameData();
            renderShopContent('knives');
            showToast(`è£å‚™: ${KNIFE_TYPES[knifeId].name}`);
        }

        function buyBoost(boostType, price) {
            if(state.coins >= price) {
                state.coins -= price;
                
                switch(boostType) {
                    case 'extraLife':
                        state.gameBoosts.extraLife++;
                        showToast("ç²å¾—é¡å¤–ç”Ÿå‘½ï¼");
                        break;
                }
                
                updateCoinsDisplay();
                saveGameData();
                renderShopContent('boosts');
            } else {
                showToast("é‡‘å¹£ä¸è¶³ï¼");
            }
        }

        function updatePlayerKnifeAppearance() {
            playerKnife.className = `knife ${state.currentKnife}`;
        }

        function startGame() {
            const savedMode = localStorage.getItem('ninja_gameMode');
            if(savedMode) state.gameMode = savedMode;
            
            startScreen.style.display = 'none';
            resetGameData();
            setupLevel(1);
            
            // æ‡‰ç”¨å¼·åŒ–æ•ˆæœ
            if(state.gameBoosts.extraLife > 0) {
                state.lives += state.gameBoosts.extraLife;
                for(let i = 3; i < state.lives; i++) {
                    const extraHeart = document.createElement('div');
                    extraHeart.className = 'heart';
                    extraHeart.style.background = '#32CD32';
                    document.getElementById('livesDisplay').appendChild(extraHeart);
                }
            }
        }

        function resetGameData() {
            state.score = 0;
            state.level = 1;
            state.lives = 3;
            state.coins = 0; // æ¯æ¬¡é–‹å§‹éŠæˆ²æ™‚é‡‘å¹£æ¸…é›¶
            state.knivesStuck = 0;
            state.combo = 0;
            state.maxCombo = 0;
            state.multiplier = 1;
            state.perfectHitCount = 0;
            state.streak = 0;
            state.perfectLevels = 0;
            resetHearts();
            updateUI();
        }

        function resetHearts() {
            const heartsDiv = document.getElementById('livesDisplay');
            heartsDiv.innerHTML = '';
            for(let i = 0; i < state.lives; i++) {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heartsDiv.appendChild(heart);
            }
        }

        function setupLevel(lvl) {
            state.level = lvl;
            state.isPlaying = true;
            state.isThrowing = false;
            
            // è¨­ç½®æ¯é—œéœ€è¦æ’æ»¿çš„é£›åˆ€æ•¸é‡
            state.knivesRequired = Math.min(5 + Math.floor(lvl/2), 15);
            state.knivesStuck = 0;
            
            state.wheelAngle = 0;
            state.wheelDirection = 1;
            state.objects = [];
            state.specialItems = [];
            
            const oldItems = wheelContainer.querySelectorAll('.knife, .spike, .apple, .banana, .special-item');
            oldItems.forEach(el => el.remove());

            resetPlayerKnife();

            const isBoss = (state.gameMode === GAME_MODES.BOSS_RUSH) || (lvl % 5 === 0);
            document.getElementById('bossIndicator').style.display = isBoss ? 'block' : 'none';
            
            if(isBoss) {
                state.wheelSpeed = 3.0 + (state.bossDefeated * 0.2);
                state.switchInterval = Math.max(800, 2000 - state.bossDefeated * 100);
            } else {
                state.wheelSpeed = 1.0 + lvl * 0.15;
                state.switchInterval = Math.max(1500, 4000 - lvl * 200);
            }

            // ç”Ÿæˆå·²æœ‰çš„é£›åˆ€
            const existingKnives = Math.min(Math.floor(lvl/2), 4);
            const usedAngles = [];
            
            for(let i=0; i<existingKnives; i++) {
                let angle;
                let attempts = 0;
                do {
                    angle = Math.floor(Math.random() * 360);
                    attempts++;
                } while(isAngleTooClose(angle, usedAngles, 30) && attempts < 100);
                
                if(attempts < 100) {
                    createObject('knife', angle);
                    usedAngles.push(angle);
                }
            }

            // ç”Ÿæˆå°–åˆº
            const spikeCount = isBoss ? 6 + Math.floor(lvl/5) : Math.min(2 + Math.floor(lvl/3), 8);
            for(let i=0; i<spikeCount; i++) {
                let angle;
                let attempts = 0;
                do {
                    angle = Math.floor(Math.random() * 360);
                    attempts++;
                } while(isAngleTooClose(angle, usedAngles, 20) && attempts < 100);
                
                if(attempts < 100) {
                    createObject('spike', angle);
                    usedAngles.push(angle);
                }
            }

            // ç”Ÿæˆè˜‹æœï¼ˆ+10é‡‘å¹£ï¼‰å’Œé¦™è•‰ï¼ˆ+5é‡‘å¹£ï¼‰
            const appleChance = 0.3;
            const bananaChance = 0.4;
            
            if(Math.random() < appleChance) {
                let angle = Math.floor(Math.random() * 360);
                if(!isAngleTooClose(angle, usedAngles, 20)) {
                    createObject('apple', angle);
                    usedAngles.push(angle);
                }
            }
            
            if(Math.random() < bananaChance) {
                let angle = Math.floor(Math.random() * 360);
                if(!isAngleTooClose(angle, usedAngles, 20)) {
                    createObject('banana', angle);
                    usedAngles.push(angle);
                }
            }

            // ç”Ÿæˆç‰¹æ®Šé“å…·
            if(lvl >= 3 && Math.random() < CONFIG.specialItemChance) {
                createSpecialItem(usedAngles);
            }

            updateComboDisplay();
            updateMultiplierDisplay();
            
            showToast(`${getModeName(state.gameMode)} - Level ${lvl}`);
        }

        function getModeName(mode) {
            const names = {
                'classic': 'ç¶“å…¸æ¨¡å¼',
                'survival': 'ç”Ÿå­˜æ¨¡å¼',
                'challenge': 'æŒ‘æˆ°æ¨¡å¼',
                'boss_rush': 'Bossé€£æˆ°'
            };
            return names[mode] || 'ç¶“å…¸æ¨¡å¼';
        }

        function isAngleTooClose(angle, list, minDist) {
            for(let a of list) {
                let diff = Math.abs(angle - a);
                if(diff > 180) diff = 360 - diff;
                if(diff < minDist) return true;
            }
            return false;
        }

        function createObject(type, angle) {
            const el = document.createElement('div');
            el.className = type;
            el.style.left = '50%';
            el.style.top = '50%';
            
            wheelContainer.appendChild(el);
            state.objects.push({ type, el, angle });
        }

        function createSpecialItem(usedAngles = []) {
            const types = [
                { type: 'shield', color: '#00BFFF', effect: 'ä¿è­·ä¸€æ¬¡ç¢°æ’' },
                { type: 'timeSlow', color: '#9B30FF', effect: 'æ¸›æ…¢è¼ªç›¤é€Ÿåº¦5ç§’' },
                { type: 'extraLife', color: '#32CD32', effect: 'é¡å¤–ç”Ÿå‘½' }
            ];
            
            const item = types[Math.floor(Math.random() * types.length)];
            let angle;
            let attempts = 0;
            
            do {
                angle = Math.floor(Math.random() * 360);
                attempts++;
            } while(isAngleTooClose(angle, usedAngles, 25) && attempts < 50);
            
            if(attempts >= 50) return;
            
            const el = document.createElement('div');
            el.className = 'special-item';
            el.style.left = '50%';
            el.style.top = '50%';
            el.style.width = '24px';
            el.style.height = '24px';
            el.style.borderRadius = '50%';
            el.style.background = `radial-gradient(circle, ${item.color}, #000)`;
            el.style.boxShadow = `0 0 15px ${item.color}`;
            el.style.border = `2px solid rgba(255,255,255,0.8)`;
            el.dataset.type = item.type;
            
            wheelContainer.appendChild(el);
            state.specialItems.push({ type: item.type, el, angle, effect: item.effect });
            
            let opacity = 1;
            const blinkInterval = setInterval(() => {
                opacity = opacity === 1 ? 0.6 : 1;
                el.style.opacity = opacity;
            }, 300);
            
            setTimeout(() => {
                clearInterval(blinkInterval);
                if(el.parentNode) {
                    el.remove();
                    state.specialItems = state.specialItems.filter(item => item.el !== el);
                }
            }, 10000);
        }

        function resetPlayerKnife() {
            state.isThrowing = false;
            playerKnife.style.display = 'block';
            playerKnife.style.bottom = '100px';
            playerKnife.style.left = '50%';
            playerKnife.style.transform = 'translateX(-50%) rotate(0deg)';
            state.playerPos.bottom = 100;
        }

        function throwKnife() {
            if (!state.isPlaying || state.isThrowing) return;

            state.isThrowing = true;
            updateUI();

            let currentBottom = 100;
            
            function animateFly() {
                currentBottom += CONFIG.knifeSpeed;
                playerKnife.style.bottom = currentBottom + 'px';

                const targetBottom = (window.innerHeight * 0.4) + CONFIG.wheelRadius - 10;

                if (currentBottom >= targetBottom) {
                    checkCollision();
                } else {
                    requestAnimationFrame(animateFly);
                }
            }
            requestAnimationFrame(animateFly);
            
            playSound('throw');
        }

        function checkCollision() {
            let hitAngle = (270 - state.wheelAngle) % 360;
            if (hitAngle < 0) hitAngle += 360;

            // æª¢æŸ¥å°–åˆº
            for (let obj of state.objects) {
                if (obj.type === 'spike') {
                    if (Math.abs(hitAngle - obj.angle) < CONFIG.collisionTolerance) {
                        triggerGameOver("ä½ æ’åˆ°äº†å°–åˆºï¼");
                        return;
                    }
                }
            }

            // æª¢æŸ¥ç‰¹æ®Šé“å…·
            let hitSpecialItem = null;
            for(let i = state.specialItems.length - 1; i >= 0; i--) {
                const item = state.specialItems[i];
                if(Math.abs(hitAngle - item.angle) < 15) {
                    hitSpecialItem = item;
                    break;
                }
            }

            if (hitSpecialItem) {
                activateSpecialItem(hitSpecialItem);
                hitSpecialItem.el.remove();
                state.specialItems = state.specialItems.filter(item => item !== hitSpecialItem);
            }

            // æª¢æŸ¥é£›åˆ€ç¢°æ’ï¼ˆåªæ‰£è¡€ï¼‰
            let hitKnife = null;
            for (let obj of state.objects) {
                if (obj.type === 'knife') {
                    if (Math.abs(hitAngle - obj.angle) < CONFIG.collisionTolerance) {
                        hitKnife = obj;
                        break;
                    }
                }
            }

            if (hitKnife) {
                if (state.lives > 0) {
                    loseLife();
                    animateBounceBack();
                    return;
                } else {
                    triggerGameOver("ç”Ÿå‘½å€¼è€—ç›¡ï¼");
                    return;
                }
            }

            // æª¢æŸ¥è˜‹æœï¼ˆ+10é‡‘å¹£ï¼‰
            let hitApple = null;
            for (let obj of state.objects) {
                if (obj.type === 'apple') {
                    if (Math.abs(hitAngle - obj.angle) < 10) {
                        hitApple = obj;
                        break;
                    }
                }
            }

            // æª¢æŸ¥é¦™è•‰ï¼ˆ+5é‡‘å¹£ï¼‰
            let hitBanana = null;
            for (let obj of state.objects) {
                if (obj.type === 'banana') {
                    if (Math.abs(hitAngle - obj.angle) < 12) {
                        hitBanana = obj;
                        break;
                    }
                }
            }

            // æª¢æŸ¥æ˜¯å¦ç‚ºå®Œç¾å‘½ä¸­
            let isPerfectHit = false;
            if(!hitKnife && !hitSpecialItem) {
                const closestAngle = findClosestObjectAngle(hitAngle);
                if(closestAngle === null || Math.abs(hitAngle - closestAngle) > 30) {
                    isPerfectHit = true;
                    state.perfectHitCount++;
                    if(state.perfectHitCount >= 10 && !ACHIEVEMENTS.PERFECT_10.unlocked) {
                        unlockAchievement('PERFECT_10');
                    }
                }
            }

            // *** æˆåŠŸå‘½ä¸­ ***
            if (hitApple) {
                hitApple.el.remove();
                state.objects = state.objects.filter(o => o !== hitApple);
                state.score += 50 * state.multiplier;
                state.coins += 10; // è˜‹æœ +10é‡‘å¹£
                showScorePopup(50);
                showToast("å‘½ä¸­è˜‹æœï¼+10é‡‘å¹£");
                updateCoinsDisplay();
            } else if (hitBanana) {
                hitBanana.el.remove();
                state.objects = state.objects.filter(o => o !== hitBanana);
                state.score += 30 * state.multiplier;
                state.coins += 5; // é¦™è•‰ +5é‡‘å¹£
                showScorePopup(30);
                showToast("å‘½ä¸­é¦™è•‰ï¼+5é‡‘å¹£");
                updateCoinsDisplay();
            } else {
                // æˆåŠŸæ’ä¸Šé£›åˆ€ï¼
                state.knivesStuck++;
                const scoreEarned = isPerfectHit ? 40 : 20;
                state.score += scoreEarned * state.multiplier;
                showScorePopup(scoreEarned);
                
                // å‰µå»ºæ–°çš„é£›åˆ€å›ºå®šåœ¨è¼ªç›¤ä¸Š
                createObject('knife', hitAngle);
                
                // æª¢æŸ¥æ˜¯å¦å®Œæˆé—œå¡
                if(state.knivesStuck >= state.knivesRequired) {
                    setTimeout(() => {
                        levelComplete();
                    }, 500);
                }
            }

            // é€£æ“Šç³»çµ±
            if(!hitKnife) {
                state.combo++;
                state.streak++;
                
                if(isPerfectHit) {
                    showPerfectEffect();
                    playSound('perfect');
                }
                
                if(state.combo >= CONFIG.comboThreshold) {
                    state.multiplier = Math.min(5, Math.floor(state.combo / CONFIG.comboThreshold) + 1);
                    showToast(`é€£æ“Š x${state.multiplier}!`);
                    updateMultiplierDisplay();
                }
                
                if(state.combo > state.maxCombo) {
                    state.maxCombo = state.combo;
                    if(state.combo >= 20 && !ACHIEVEMENTS.COMBO_KING.unlocked) {
                        unlockAchievement('COMBO_KING');
                    }
                }
                
                updateComboDisplay();
            } else {
                if(state.combo > 0) {
                    showToast(`é€£æ“Šä¸­æ–·ï¼æœ€å¤§é€£æ“Š: ${state.maxCombo}`);
                }
                state.combo = 0;
                state.multiplier = 1;
                state.streak = 0;
                updateComboDisplay();
                updateMultiplierDisplay();
            }

            // å°‡ç©å®¶é£›åˆ€æ¶ˆå¤±ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æŠ•æ“²
            playerKnife.style.display = 'none';
            state.isThrowing = false;
            
            // ç­‰å¾…ä¸€å°æ®µæ™‚é–“å¾Œé‡ç½®ç©å®¶é£›åˆ€ï¼ˆå¯ä»¥ç¹¼çºŒæŠ•æ“²ï¼‰
            setTimeout(() => {
                resetPlayerKnife();
            }, 200);

            updateUI();
            
            // ç”Ÿå­˜æ¨¡å¼æª¢æŸ¥æˆå°±
            if(state.gameMode === GAME_MODES.SURVIVAL && state.score >= 500 && !ACHIEVEMENTS.SURVIVAL_MASTER.unlocked) {
                unlockAchievement('SURVIVAL_MASTER');
            }
        }

        function findClosestObjectAngle(hitAngle) {
            let closest = null;
            let minDiff = 360;
            
            for(let obj of state.objects) {
                let diff = Math.abs(hitAngle - obj.angle);
                if(diff > 180) diff = 360 - diff;
                if(diff < minDiff) {
                    minDiff = diff;
                    closest = obj.angle;
                }
            }
            
            return closest;
        }

        function activateSpecialItem(item) {
            showToast(`ç²å¾—: ${item.effect}`);
            playSound('special');
            
            switch(item.type) {
                case 'shield':
                    const shield = document.createElement('div');
                    shield.className = 'hit-effect';
                    shield.style.background = 'radial-gradient(circle, rgba(0,191,255,0.8), transparent)';
                    shield.style.width = '80px';
                    shield.style.height = '80px';
                    shield.style.left = '50%';
                    shield.style.top = '50%';
                    shield.style.transform = 'translate(-50%, -50%)';
                    document.body.appendChild(shield);
                    setTimeout(() => shield.remove(), 1000);
                    
                    state.lives = Math.min(state.lives + 1, 3);
                    const hearts = document.querySelectorAll('.heart');
                    for(let heart of hearts) {
                        if(heart.classList.contains('lost')) {
                            heart.classList.remove('lost');
                            heart.style.opacity = '1';
                            break;
                        }
                    }
                    break;
                    
                case 'timeSlow':
                    const originalSpeed = state.wheelSpeed;
                    state.wheelSpeed *= 0.4;
                    showToast("æ™‚é–“æ¸›æ…¢ï¼");
                    
                    wheel.style.filter = 'hue-rotate(180deg)';
                    
                    setTimeout(() => {
                        state.wheelSpeed = originalSpeed;
                        wheel.style.filter = 'none';
                        showToast("æ™‚é–“æ¢å¾©æ­£å¸¸");
                    }, 5000);
                    break;
                    
                case 'extraLife':
                    state.lives = Math.min(state.lives + 1, 5);
                    for(let i = 0; i < state.lives; i++) {
                        if(i >= 3) {
                            const heartsContainer = document.getElementById('livesDisplay');
                            if(heartsContainer.children.length < state.lives) {
                                const extraHeart = document.createElement('div');
                                extraHeart.className = 'heart';
                                extraHeart.style.background = '#32CD32';
                                heartsContainer.appendChild(extraHeart);
                            }
                        }
                    }
                    break;
            }
        }

        function loseLife() {
            state.lives--;
            const hearts = document.querySelectorAll('.heart');
            for (let i = hearts.length - 1; i >= 0; i--) {
                if (!hearts[i].classList.contains('lost')) {
                    hearts[i].classList.add('lost');
                    break;
                }
            }
            
            if(state.combo > 0) {
                showToast(`é€£æ“Šä¸­æ–·ï¼æœ€å¤§é€£æ“Š: ${state.maxCombo}`);
            }
            state.combo = 0;
            state.multiplier = 1;
            state.streak = 0;
            updateComboDisplay();
            updateMultiplierDisplay();
            
            showToast("å°å¿ƒï¼ç”Ÿå‘½å€¼æ¸›å°‘");
            playSound('hit');
        }

        function animateBounceBack() {
            let currentBottom = parseFloat(playerKnife.style.bottom);
            function bounce() {
                currentBottom -= 15;
                playerKnife.style.bottom = currentBottom + 'px';
                if (currentBottom > 100) {
                    requestAnimationFrame(bounce);
                } else {
                    resetPlayerKnife();
                }
            }
            requestAnimationFrame(bounce);
        }

        function showPerfectEffect() {
            const effect = document.createElement('div');
            effect.className = 'hit-effect';
            effect.style.left = '50%';
            effect.style.top = '50%';
            effect.style.transform = 'translate(-50%, -50%)';
            effect.style.background = 'radial-gradient(circle, rgba(255,215,0,0.9), rgba(255,69,0,0.7))';
            document.body.appendChild(effect);
            
            setTimeout(() => effect.remove(), 500);
        }

        function showScorePopup(points) {
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.textContent = `+${points}`;
            popup.style.left = '50%';
            popup.style.bottom = '200px';
            popup.style.transform = 'translateX(-50%)';
            
            if(points >= 20) {
                popup.style.color = '#FF4500';
                popup.style.fontSize = '28px';
            }
            
            document.getElementById('gameContainer').appendChild(popup);
            
            setTimeout(() => popup.remove(), 1000);
        }

        function updateComboDisplay() {
            if(state.combo > 1) {
                comboDisplay.textContent = `é€£æ“Š: ${state.combo} æ¬¡`;
                comboDisplay.style.opacity = '1';
            } else {
                comboDisplay.style.opacity = '0';
            }
        }

        function updateMultiplierDisplay() {
            if(state.multiplier > 1) {
                multiplierDisplay.textContent = `x${state.multiplier}`;
                multiplierDisplay.style.opacity = '1';
            } else {
                multiplierDisplay.style.opacity = '0';
            }
        }

        function updateCoinsDisplay() {
            coinsDisplay.textContent = state.coins;
        }

        // éŠæˆ²ä¸»å¾ªç’°
        let lastTime = 0;
        function gameLoop(timestamp) {
            if (!lastTime) lastTime = timestamp;
            const delta = timestamp - lastTime;

            if (state.isPlaying) {
                state.wheelAngle += state.wheelSpeed * state.wheelDirection;
                
                if (timestamp - state.lastSwitchTime > state.switchInterval) {
                    if (Math.random() > 0.6) {
                        state.wheelDirection *= -1;
                        showToast("æ—‹è½‰æ–¹å‘æ”¹è®Šï¼");
                    }
                    state.lastSwitchTime = timestamp;
                }

                wheel.style.transform = `rotate(${state.wheelAngle}deg)`;
                
                state.objects.forEach(obj => {
                    const rotation = obj.angle + state.wheelAngle;
                    const visualRotation = rotation + 90;
                    
                    if (obj.type === 'knife' || obj.type === 'spike') {
                         const rad = rotation * Math.PI / 180;
                         const x = Math.cos(rad) * CONFIG.wheelRadius;
                         const y = Math.sin(rad) * CONFIG.wheelRadius;
                         
                         obj.el.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) rotate(${visualRotation}deg)`;
                    } else if (obj.type === 'apple' || obj.type === 'banana') {
                        const rad = rotation * Math.PI / 180;
                        const x = Math.cos(rad) * (CONFIG.wheelRadius - 10);
                        const y = Math.sin(rad) * (CONFIG.wheelRadius - 10);
                        obj.el.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
                    }
                });
                
                state.specialItems.forEach(item => {
                    const rotation = item.angle + state.wheelAngle;
                    const rad = rotation * Math.PI / 180;
                    const x = Math.cos(rad) * (CONFIG.wheelRadius + 20);
                    const y = Math.sin(rad) * (CONFIG.wheelRadius + 20);
                    item.el.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
                });
            }

            lastTime = timestamp;
            requestAnimationFrame(gameLoop);
        }

        function levelComplete() {
            state.isPlaying = false;
            
            // æ¯éä¸€é—œ +50é‡‘å¹£
            state.coins += 50;
            
            // Bossæˆ°ç‰¹æ®Šè™•ç†
            const isBoss = state.level % 5 === 0;
            if(isBoss) {
                state.bossDefeated++;
                if(state.bossDefeated >= 10 && !ACHIEVEMENTS.BOSS_SLAYER.unlocked) {
                    unlockAchievement('BOSS_SLAYER');
                }
            }
            
            // å®Œç¾é€šé—œæª¢æŸ¥ï¼ˆç„¡å‚·ï¼‰
            if(state.lives === 3) {
                state.perfectLevels++;
                if(state.perfectLevels >= 5 && !ACHIEVEMENTS.PERFECT_GAME.unlocked) {
                    unlockAchievement('PERFECT_GAME');
                }
            } else {
                state.perfectLevels = 0;
            }
            
            document.getElementById('lcKnives').innerText = state.knivesStuck;
            document.getElementById('lcScore').innerText = state.score;
            document.getElementById('lcCoins').innerText = 50;
            
            // ç”Ÿå­˜æ¨¡å¼ä¸é¡¯ç¤ºé—œå¡å®Œæˆ
            if(state.gameMode === GAME_MODES.SURVIVAL) {
                setTimeout(() => {
                    setupLevel(state.level + 1);
                }, 1000);
            } else {
                document.getElementById('levelCompleteModal').style.display = 'block';
            }
            
            updateCoinsDisplay();
            saveGameData();
        }

        window.nextLevelWithAnim = function() {
            document.getElementById('levelCompleteModal').style.display = 'none';
            
            document.getElementById('transitionLevelText').innerText = `Level ${state.level + 1}`;
            levelTransition.classList.add('slide-in');
            
            setTimeout(() => {
                levelTransition.classList.remove('slide-in');
                setupLevel(state.level + 1);
            }, 1800);
        }

        window.initGame = function() {
            document.getElementById('gameOverModal').style.display = 'none';
            resetGameData();
            setupLevel(1);
        }

        function returnToMenu() {
            document.getElementById('gameOverModal').style.display = 'none';
            document.getElementById('levelCompleteModal').style.display = 'none';
            startScreen.style.display = 'flex';
            state.isPlaying = false;
            updateCoinsDisplay();
        }

        function triggerGameOver(reason) {
            state.isPlaying = false;
            document.getElementById('goReason').innerText = reason;
            document.getElementById('goScore').innerText = state.score;
            document.getElementById('goCombo').innerText = state.maxCombo;
            document.getElementById('goCoins').innerText = state.coins;
            document.getElementById('gameOverModal').style.display = 'block';
            
            saveGameData();
        }

        function updateUI() {
            document.getElementById('levelDisplay').innerText = state.level;
            document.getElementById('scoreDisplay').innerText = state.score;
            document.getElementById('knifeCounter').innerText = `å·²æ’: ${state.knivesStuck}/${state.knivesRequired}`;
            updateCoinsDisplay();
        }

        function showToast(msg) {
            toastEl.innerText = msg;
            toastEl.style.opacity = '1';
            setTimeout(() => {
                toastEl.style.opacity = '0';
            }, 1500);
        }

        function unlockAchievement(achievementKey) {
            ACHIEVEMENTS[achievementKey].unlocked = true;
            state.achievements[achievementKey] = true;
            
            localStorage.setItem('ninja_achievements', JSON.stringify(state.achievements));
            
            const achievement = ACHIEVEMENTS[achievementKey];
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.innerHTML = `
                <h3 style="color:#FFD700;">æˆå°±è§£é–ï¼</h3>
                <h4 style="color:#FFF;">${achievement.name}</h4>
                <p style="color:#CCC;">${achievement.desc}</p>
                <p style="color:#FFD700;">+${achievement.reward} é‡‘å¹£</p>
            `;
            
            document.body.appendChild(notification);
            state.coins += achievement.reward;
            updateCoinsDisplay();
            saveGameData();
            
            setTimeout(() => {
                if(notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // ç°¡æ˜“éŸ³æ•ˆç³»çµ±
        function playSound(type) {
            console.log(`æ’­æ”¾éŸ³æ•ˆ: ${type}`);
        }

    </script>
</body>
</html>